<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลผู้ป่วย | โรงพยาบาลกำแพงเพชร</title>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

    <style>
        body {
            font-family: "Sarabun", sans-serif;
            background-color: #f4f7f6;
            color: #333;
            padding-top: 80px;
        }

        /* Navbar Styling */
        .navbar-custom {
            height: 80px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .04);
        }

        .brand-logo {
            height: 45px;
            width: auto;
        }

        .brand-text h1 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 0;
            line-height: 1.1;
        }

        .brand-text small {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* User Profile Styling */
        .user-profile-btn {
            display: flex;
            align-items: center;
            padding: 5px 15px 5px 5px;
            border: 1px solid #eee;
            border-radius: 12px;
            background-color: #fff;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .user-profile-btn:hover,
        .show>.user-profile-btn {
            background-color: #f8f9fa;
            border-color: #e2e6ea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .user-avatar {
            width: 38px;
            height: 38px;
            background-color: #2C3E50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .user-info {
            margin-left: 10px;
            margin-right: 15px;
            line-height: 1.2;
            text-align: left;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }

        .user-role {
            font-size: 0.75rem;
            color: #888;
        }

        .dropdown-toggle::after {
            display: none;
        }

        /* --- HIS Standard Style (Card แบบทางการ/คลีน) --- */
        .his-container {
            background-color: #fff;
            border: 1px solid #c8c8c8;
            border-left: 6px solid #999;
            border-radius: 4px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .his-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 2px;
            font-weight: 600;
        }

        .his-value {
            font-size: 0.95rem;
            color: #333;
            font-weight: 500;
        }

        .his-result {
            font-size: 1.4rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .his-desc {
            font-size: 0.85rem;
            color: #555;
            margin-top: 2px;
        }

        .his-score-box {
            display: inline-block;
            background: #f0f0f0;
            color: #000;
            border: 1px solid #ccc;
            padding: 2px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .his-divider {
            border-right: 1px solid #e0e0e0;
            min-height: 40px;
        }

        /* Colors */
        .his-normal {
            border-left-color: #28a745 !important;
        }

        .text-his-normal {
            color: #218838;
        }

        .his-risk {
            border-left-color: #ff8800 !important;
        }

        .text-his-risk {
            color: #d65b00;
        }

        .his-severe {
            border-left-color: #dc3545 !important;
        }

        .text-his-severe {
            color: #c82333;
        }

        /* --- Dropdown Disabled Logic --- */
        .dropdown-item.disabled-action {
            background-color: #f8f9fa;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .dropdown-item.disabled-action .title-text,
        .dropdown-item.disabled-action .sub-text,
        .dropdown-item.disabled-action .icon-box {
            color: #adb5bd !important;
        }

        .dropdown-item.disabled-action:hover {
            background-color: #f8f9fa;
        }

        /* General */
        .patient-icon-box {
            width: 120px;
            height: 150px;
            background-color: #e3f2fd;
            color: #2C3E50;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            border: 1px solid #bbdefb;
        }

        .badge-status-normal {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .badge-status-risk {
            background-color: #fff8e1;
            color: #f57c00;
        }

        .badge-status-severe {
            background-color: #ffebee;
            color: #c62828;
        }

        .doc-link {
            color: #3498DB;
            font-weight: 600;
            text-decoration: none;
        }

        .doc-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-md navbar-light fixed-top navbar-custom border-bottom">
        <div class="container-fluid px-lg-4">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="img/logo_kph.jpg" class="brand-logo mr-2 d-none d-sm-block" alt="Logo"
                    onerror="this.style.display='none'">
                <div class="brand-text">
                    <h1>ระบบประเมินภาวะโภชนาการ</h1>
                    <small>Nutrition Alert System (NAS)</small>
                </div>
            </a>

            <ul class="navbar-nav ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link p-0" href="#" id="userDropdown" role="button" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false" style="min-width: 250px;">
                        <div class="user-profile-btn">
                            <div class="user-avatar">
                                <i class="fa-solid fa-user-doctor"></i>
                            </div>
                            <div class="user-info d-none d-md-block" style="flex-grow: 1;">
                                <div class="user-name">เพชรลดา เชยเพ็ชร</div>
                                <div class="user-role">นักโภชนาการ</div>
                            </div>
                            <i class="fa-solid fa-chevron-down text-muted mr-2" style="font-size: 0.8rem;"></i>
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow border-0 mt-2" aria-labelledby="userDropdown"
                        style="border-radius: 12px; min-width: 250px;">

                        <div class="dropdown-header bg-light border-bottom py-3">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar mr-3" style="width: 42px; height: 42px; font-size: 1.2rem;">
                                    <i class="fa-solid fa-user-doctor"></i>
                                </div>
                                <div style="line-height: 1.3;">
                                    <strong class="text-dark d-block" style="font-size: 0.95rem;">เพชรลดา
                                        เชยเพ็ชร</strong>
                                    <small class="text-muted">นักโภชนาการชำนาญการ</small>
                                    <br>
                                    <span class="badge badge-info mt-1"
                                        style="font-weight: normal; font-size: 0.7rem;">License: DT-66099</span>
                                </div>
                            </div>
                        </div>

                        <div class="p-2">
                            <h6 class="dropdown-header text-uppercase text-muted small font-weight-bold pl-2 mb-1">
                                งานของฉัน</h6>
                            <a class="dropdown-item py-2 rounded d-flex justify-content-between align-items-center"
                                href="#">
                                <span><i class="fa-solid fa-clipboard-user mr-2 text-primary"
                                        style="width:20px; text-align:center;"></i> ผู้ป่วยที่รับผิดชอบ</span>
                                <span class="badge badge-danger badge-pill">5</span>
                            </a>
                            <a class="dropdown-item py-2 rounded" href="#">
                                <span><i class="fa-solid fa-comment-medical mr-2 text-success"
                                        style="width:20px; text-align:center;"></i> จัดการข้อความด่วน</span>
                            </a>
                            <a class="dropdown-item py-2 rounded" href="#">
                                <span><i class="fa-solid fa-clock-rotate-left mr-2 text-secondary"
                                        style="width:20px; text-align:center;"></i> ประวัติการประเมิน</span>
                            </a>
                        </div>

                        <div class="dropdown-divider m-0"></div>

                        <div class="p-2">
                            <a class="dropdown-item py-2 rounded" href="#">
                                <i class="fa-solid fa-file-signature mr-2 text-warning"
                                    style="width:20px; text-align:center;"></i> ตั้งค่าลายเซ็น (E-Sign)
                            </a>
                        </div>

                        <div class="dropdown-divider m-0"></div>

                        <div class="p-2">
                            <a class="dropdown-item py-2 rounded text-danger" href="#" onclick="confirmLogout()">
                                <i class="fa-solid fa-right-from-bracket mr-2"
                                    style="width:20px; text-align:center;"></i>
                                ออกจากระบบ
                            </a>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid px-lg-5 mt-4">

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-auto">
                        <div class="patient-icon-box"><i class="fa-solid fa-user-injured"></i></div>
                    </div>
                    <div class="col">
                        <h5 class="text-primary-custom font-weight-bold mb-3 border-bottom pb-2 d-inline-block">
                            <i class="fa-solid fa-hospital-user mr-2"></i>ข้อมูลผู้ป่วย
                        </h5>
                        <div class="row">
                            <div class="col-6 col-md-3 col-lg-2 mb-3">
                                <small class="text-muted d-block">HN</small>
                                <span class="font-weight-bold" id="p_hn">-</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 mb-3">
                                <small class="text-muted d-block">AN</small>
                                <span class="font-weight-bold" id="p_an">-</span>
                            </div>
                            <div class="col-12 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">ชื่อ - นามสกุล</small>
                                <span class="font-weight-bold text-primary-custom" id="p_name"
                                    style="font-size: 1.1rem;">-</span>
                            </div>
                            <div class="col-6 col-md-4 col-lg-2 mb-3">
                                <small class="text-muted d-block">อายุ</small>
                                <span class="font-weight-bold" id="p_age">-</span>
                            </div>
                            <div class="col-6 col-md-8 col-lg-2 mb-3">
                                <small class="text-muted d-block">สิทธิการรักษา</small>
                                <span class="font-weight-bold" id="p_rights">-</span>
                            </div>
                            <div class="col-12 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">แพทย์เจ้าของไข้</small>
                                <span class="font-weight-bold" id="p_doctor">-</span>
                            </div>
                            <div class="col-6 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">หอผู้ป่วย / เตียง</small>
                                <span class="font-weight-bold" id="p_ward">-</span>
                            </div>
                            <div class="col-6 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">วันที่ Admit</small>
                                <span class="font-weight-bold" id="p_admit">-</span>
                            </div>
                            <div class="col-6 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">เบอร์โทรศัพท์</small>
                                <span class="font-weight-bold" id="p_phone">-</span>
                            </div>
                            <div class="col-12 col-md-6 col-lg-4 mb-3">
                                <small class="text-muted d-block">โรคประจำตัว</small>
                                <span class="font-weight-bold text-danger" id="p_underlying">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="index.html" class="btn btn-outline-secondary btn-sm" style="border-radius: 4px; ">
                <i class="fa-solid fa-chevron-left mr-2"></i> กลับหน้าหลัก
            </a>

            <div class="btn-group">
                <button type="button" class="btn btn-primary px-4 shadow-sm dropdown-toggle" data-toggle="dropdown"
                    style="background-color: #0d47a1; border-color: #0d47a1; border-radius: 4px; height: 40px; font-size: 1rem;">
                    <i class="fa-solid fa-folder-plus mr-2"></i> เพิ่มไฟล์เอกสารใหม่
                </button>

                <div class="dropdown-menu dropdown-menu-right border shadow-sm p-0 mt-1"
                    style="min-width: 380px; border-radius: 4px; border-color: #ced4da;">

                    <div class="bg-light px-3 py-2 border-bottom">
                        <small class="text-uppercase text-muted font-weight-bold"
                            style="font-size: 0.75rem; letter-spacing: 0.5px;">
                            เลือกประเภทของเอกสาร
                        </small>
                    </div>

                    <a href="#" class="dropdown-item py-3 px-3 menu-action-link border-bottom" id="menu_spent"
                        onclick="handleAction('SPENT', 'nutrition_screening_form.html')" style="transition: all 0.2s;">
                        <div class="d-flex">
                            <div class="mr-3 d-flex align-items-center justify-content-center icon-box"
                                style="width: 45px; height: 45px; background-color: #f1f8ff; border: 1px solid #d0e2f5; border-radius: 4px; color: #0d47a1;">
                                <i class="fa-solid fa-file-medical fa-lg"></i>
                            </div>

                            <div class="w-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="font-weight-bold text-dark title-text"
                                        style="font-size: 1rem;">แบบคัดกรองภาวะโภชนาการ</span>
                                </div>
                                <small class="text-muted sub-text d-block mb-1" style="font-size: 0.85rem;">SPENT
                                    Nutrition
                                    Screening Tool</small>

                                <div class="reason-text d-none mt-1"
                                    style="font-size: 0.75rem; background-color: #fff5f5; color: #c00; border: 1px solid #fcc; padding: 4px 8px; border-radius: 2px;">
                                </div>
                            </div>
                        </div>
                    </a>

                    <a href="#" class="dropdown-item py-3 px-3 menu-action-link" id="menu_naf"
                        onclick="handleAction('NAF', 'nutrition_alert_form.html')" style="transition: all 0.2s;">
                        <div class="d-flex">
                            <div class="mr-3 d-flex align-items-center justify-content-center icon-box"
                                style="width: 45px; height: 45px; background-color: #f1f8ff; border: 1px solid #d0e2f5; border-radius: 4px; color: #0d47a1;">
                                <i class="fa-solid fa-clipboard-user fa-lg"></i>
                            </div>

                            <div class="w-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="font-weight-bold text-dark title-text"
                                        style="font-size: 1rem;">แบบประเมินภาวะโภชนาการ</span>
                                </div>
                                <small class="text-muted sub-text d-block mb-1" style="font-size: 0.85rem;">Nutrition
                                    Alert Form
                                    (NAF)</small>

                                <div class="reason-text d-none mt-1"
                                    style="font-size: 0.75rem; background-color: #fff5f5; color: #c00; border: 1px solid #fcc; padding: 4px 8px; border-radius: 2px;">
                                </div>
                            </div>
                        </div>
                    </a>

                </div>
            </div>
        </div>

        <div id="currentStatusCard" class="his-container d-none">
            <div class="row align-items-center">
                <div class="col-md-5 his-divider">
                    <div class="his-label" id="cur_type_label">ผลการประเมิน</div>
                    <div class="d-flex align-items-center">
                        <div id="cur_status_text" class="his-result mr-2">-</div>
                    </div>
                    <div id="cur_status_desc" class="his-desc">-</div>
                </div>
                <div class="col-md-2 his-divider text-center">
                    <div class="his-label">คะแนนรวม</div>
                    <div id="cur_score_val" class="his-score-box mt-1">-</div>
                </div>
                <div class="col-md-5 pl-md-4">
                    <div class="row">
                        <div class="col-6">
                            <div class="his-label" id="cur_date_label">วันที่บันทึก</div>
                            <div class="his-value" id="cur_date_text">-</div>
                        </div>
                        <div class="col-6">
                            <div class="his-label">ผู้ประเมิน</div>
                            <div class="his-value text-truncate" id="cur_assessor_text">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border shadow-sm mb-5">
            <div class="card-header bg-white py-3 d-flex flex-wrap justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary-custom">
                    <i class="fa-solid fa-clock-rotate-left mr-2"></i> ประวัติการบันทึกข้อมูลทั้งหมด
                </h6>
                <div class="form-inline mt-2 mt-md-0">
                    <label class="small text-muted mr-2"><i class="fa-solid fa-filter"></i> กรองข้อมูล:</label>
                    <select id="typeFilter" class="form-control form-control-sm custom-select" onchange="filterTable()">
                        <option value="all">ทั้งหมด (All)</option>
                        <option value="NAF">แบบประเมิน (NAF)</option>
                        <option value="SPENT">แบบคัดกรอง (SPENT)</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 25%;">รายการบันทึก</th>
                                <th class="text-center" style="width: 10%;">ประเภท</th>
                                <th class="text-center" style="width: 5%;">คะแนน</th>
                                <th style="width: 12%;">ผลการคัดกรอง</th>
                                <th style="width: 12%;">ผลการประเมิน</th>
                                <th style="width: 13%;">ผู้ประเมิน</th>
                                <th style="width: 10%;">วัน/เวลาที่บันทึก</th>
                                <th style="width: 10%;">วัน/เวลาที่แก้ไข</th>
                                <th class="text-center" style="width: 5%;">เอกสาร</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
                <div id="noDataMessage" class="text-center py-5 d-none">
                    <p class="text-muted mb-0">ยังไม่มีประวัติการบันทึกข้อมูล</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>

    <script>
        // --- 1. ข้อมูลจำลอง (Mock Data) แบบ Dynamic Date ---
        // คำนวณวันที่ "วันนี้" เพื่อให้ Logic 7 วันทำงานได้จริงในการทดสอบ
        const now = new Date();
        const thMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
        const d = now.getDate();
        const m = thMonths[now.getMonth()];
        const y = (now.getFullYear() + 543) - 2500; // แปลงเป็นปี 67, 68
        const todayStr = `${d} ${m} ${y}`; // เช่น "22 ธ.ค. 67"

        const patientsData = {
            '6604589': { // นายสมชาย (TEST CASE: เพิ่งคัดกรองวันนี้ -> เสี่ยง)
                info: {
                    hn: '6604589', an: '6700123', name: 'นายสมชาย ใจดี', age: '45 ปี',
                    rights: 'บัตรทอง', underlying: 'ความดันโลหิตสูง (HT)',
                    doctor: 'นพ. สมศักดิ์ รักษาดี', ward: 'อายุรกรรมชาย 1 / 101', admit: '15 พ.ย. 67 08:30 น.', phone: '081-111-1111'
                },
                history: [
                    // SPENT ทำวันนี้ -> ต้องล็อกปุ่ม SPENT แต่เปิดปุ่ม NAF เพราะเสี่ยง
                    { type: 'SPENT', ref: 'SP-TEST-001', score: 3, spentResult: 'มีความเสี่ยง', nafResult: '-', user: 'ทดสอบ ระบบ', date: todayStr, time: '10:00 น.', edit: '-', title: 'แบบคัดกรองภาวะโภชนาการ (ล่าสุด)' },
                    { type: 'NAF', ref: 'NAF-OLD', score: 4, spentResult: '-', nafResult: 'ปกติ (Normal)', user: 'เพชรลดา เชยเพ็ชร', date: '1 พ.ย. 66', time: '09:00 น.', edit: '-', title: 'แบบประเมินภาวะโภชนาการ (เก่า)' }
                ]
            },
            '6605112': { // นางสมหญิง (TEST CASE: เพิ่งคัดกรองวันนี้ -> ปกติ)
                info: {
                    hn: '6605112', an: '6700145', name: 'นางสมหญิง รักเรียน', age: '62 ปี',
                    rights: 'ข้าราชการ', underlying: 'เบาหวาน (DM), โรคไต (CKD)',
                    doctor: 'พญ. ใจดี มีเมตตา', ward: 'อายุรกรรมหญิง 2 / 102', admit: '25 พ.ย. 67 10:15 น.', phone: '082-222-2222'
                },
                history: []
            },
            '6603321': { // นายวิชัย (TEST CASE: คัดกรองนานแล้ว)
                info: {
                    hn: '6603321', an: '6700189', name: 'นายวิชัย กล้าหาญ', age: '75 ปี',
                    rights: 'ประกันสังคม', underlying: 'ไขมันในเลือดสูง (DLP)',
                    doctor: 'นพ. เก่งกาจ วิชาการ', ward: 'อายุรกรรมชาย 1 / 103', admit: '18 พ.ย. 67 14:20 น.', phone: '083-333-3333'
                },
                history: [
                    // เกิน 7 วัน -> กด SPENT ได้
                    { type: 'SPENT', ref: 'SP-OLD', score: 3, spentResult: 'มีความเสี่ยง', nafResult: '-', user: 'เพชรลดา เชยเพ็ชร', date: '1 ต.ค. 67', time: '14:30 น.', edit: '-', title: 'แบบคัดกรองภาวะโภชนาการ (เก่า)' }
                ]
            },
            '6609888': {
                info: {
                    hn: '6609888', an: '6700300', name: 'นายมั่นคง ทรงพลัง', age: '55 ปี',
                    rights: 'ชำระเงินเอง', underlying: 'ปฏิเสธโรคประจำตัว',
                    doctor: 'นพ. เชี่ยวชาญ งานละเอียด', ward: 'ศัลยกรรมกระดูก 3 / 105', admit: '10 พ.ย. 67 20:45 น.', phone: '084-444-4444'
                },
                history: [
                    { type: 'SPENT', ref: 'SP-671110-001', score: 0, spentResult: 'ปกติ', nafResult: '-', user: 'เพชรลดา เชยเพ็ชร', date: '10 พ.ย. 67', time: '21:00 น.', edit: '-', title: 'แบบคัดกรองภาวะโภชนาการ (ครั้งที่ 1)' }
                ]
            }
        };

        // ตัวแปรเก็บสถานะ Action
        let actionState = {
            SPENT: { enabled: true, reason: '' },
            NAF: { enabled: true, reason: '' }
        };

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const hn = urlParams.get('hn');

            if (hn && patientsData[hn]) {
                const p = patientsData[hn];

                // Render Info
                document.getElementById('p_hn').innerText = p.info.hn;
                document.getElementById('p_an').innerText = p.info.an;
                document.getElementById('p_name').innerText = p.info.name;
                document.getElementById('p_age').innerText = p.info.age;
                document.getElementById('p_rights').innerText = p.info.rights;
                document.getElementById('p_underlying').innerText = p.info.underlying;
                document.getElementById('p_doctor').innerText = p.info.doctor;
                document.getElementById('p_ward').innerText = p.info.ward;
                document.getElementById('p_admit').innerText = p.info.admit;
                document.getElementById('p_phone').innerText = p.info.phone;

                // Render Tables & Status
                renderHistoryTable(p.history);
                renderCurrentStatus(p.history);
                updateDropdownLogic(p.history);

            } else {
                document.getElementById('p_name').innerHTML = '<span class="text-danger">ไม่พบข้อมูลผู้ป่วย</span>';
                document.getElementById('historyTableBody').innerHTML = '';
                document.getElementById('noDataMessage').classList.remove('d-none');
            }
        });

        // --- Render History Table ---
        function renderHistoryTable(historyData) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (!historyData || historyData.length === 0) {
                document.getElementById('noDataMessage').classList.remove('d-none');
                return;
            }

            historyData.forEach(item => {
                let spentBadge = '<span class="badge badge-wait">-</span>';
                if (item.spentResult !== '-') {
                    if (item.spentResult === 'ปกติ') spentBadge = '<span class="badge badge-status-normal">ปกติ</span>';
                    else spentBadge = '<span class="badge badge-status-risk">มีความเสี่ยง</span>';
                }

                let nafBadge = '<span class="badge badge-wait">-</span>';
                if (item.nafResult !== '-') {
                    if (item.nafResult.includes('ปกติ')) nafBadge = '<span class="badge badge-status-normal">' + item.nafResult + '</span>';
                    else if (item.nafResult.includes('ปานกลาง')) nafBadge = '<span class="badge badge-status-risk">' + item.nafResult + '</span>';
                    else nafBadge = '<span class="badge badge-status-severe">' + item.nafResult + '</span>';
                }

                let typeBadge = (item.type === 'NAF')
                    ? '<span class="badge badge-pill badge-type-naf">NAF</span>'
                    : '<span class="badge badge-pill badge-type-spent">SPENT</span>';

                let editShow = (item.edit === '-') ? '<span class="text-muted">-</span>'
                    : `<div style="line-height:1.2">${item.edit.split(' ')[0]} ${item.edit.split(' ')[1]} ${item.edit.split(' ')[2]}<br><small class="text-muted">${item.edit.split(' ')[3]}</small></div>`;

                const rowHTML = `
                    <tr data-type="${item.type}">
                        <td>
                            <a href="#" class="doc-link">${item.title}</a>
                            <div class="doc-subtext">Ref: ${item.ref}</div>
                        </td>
                        <td class="text-center">${typeBadge}</td>
                        <td class="text-center font-weight-bold">${item.score}</td>
                        <td>${spentBadge}</td>
                        <td>${nafBadge}</td>
                        <td>${item.user}</td>
                        <td>
                            <div style="line-height:1.2">${item.date}<br><small class="text-muted">${item.time}</small></div>
                        </td>
                        <td class="text-center">${editShow}</td>
                        <td class="text-center"><a href="#" class="text-danger h5"><i class="fa-solid fa-file-pdf"></i></a></td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', rowHTML);
            });
        }

        function filterTable() {
            var input = document.getElementById("typeFilter");
            var filter = input.value;
            var tableBody = document.getElementById("historyTableBody");
            var tr = tableBody.getElementsByTagName("tr");

            for (var i = 0; i < tr.length; i++) {
                var type = tr[i].getAttribute("data-type");
                if (filter === "all" || type === filter) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }

        // --- Render Current Status (HIS Standard) ---
        function renderCurrentStatus(historyData) {
            const card = document.getElementById('currentStatusCard');

            if (!historyData || historyData.length === 0) {
                card.classList.add('d-none');
                return;
            }

            card.classList.remove('d-none');
            const latest = historyData[0];

            // Elements
            const typeLabelElem = document.getElementById('cur_type_label');
            const statusTextElem = document.getElementById('cur_status_text');
            const statusDescElem = document.getElementById('cur_status_desc');
            const scoreValElem = document.getElementById('cur_score_val');
            const dateLabelElem = document.getElementById('cur_date_label');
            const dateTextElem = document.getElementById('cur_date_text');
            const assessorElem = document.getElementById('cur_assessor_text');

            // Reset Styles
            card.classList.remove('his-normal', 'his-risk', 'his-severe');
            statusTextElem.className = 'his-result';

            let themeClass = '';
            let textClass = '';
            let statusDesc = '';

            // Logic
            if (latest.type === 'NAF') {
                typeLabelElem.innerText = 'ผลการประเมิน NAF';
                dateLabelElem.innerText = 'วัน/เวลาที่ประเมิน';
                statusTextElem.innerText = latest.nafResult;

                if (latest.nafResult.includes('ปกติ')) {
                    themeClass = 'his-normal'; textClass = 'text-his-normal';
                    statusDesc = 'ภาวะโภชนาการปกติ';
                } else if (latest.nafResult.includes('ปานกลาง')) {
                    themeClass = 'his-risk'; textClass = 'text-his-risk';
                    statusDesc = 'มีความเสี่ยงระดับปานกลาง';
                } else {
                    themeClass = 'his-severe'; textClass = 'text-his-severe';
                    statusDesc = 'มีภาวะทุพโภชนาการรุนแรง';
                }
            } else {
                typeLabelElem.innerText = 'ผลการคัดกรอง SPENT';
                dateLabelElem.innerText = 'วัน/เวลาที่คัดกรอง';
                statusTextElem.innerText = latest.spentResult;

                if (latest.spentResult === 'ปกติ') {
                    themeClass = 'his-normal'; textClass = 'text-his-normal';
                    statusDesc = 'ไม่พบความเสี่ยง';
                } else {
                    themeClass = 'his-risk'; textClass = 'text-his-risk';
                    statusDesc = 'มีความเสี่ยง';
                }
            }

            // Apply
            card.classList.add(themeClass);
            statusTextElem.classList.add(textClass);
            scoreValElem.innerText = latest.score;
            statusDescElem.innerText = statusDesc;
            dateTextElem.innerHTML = `${latest.date} <span style="font-size:0.85em; color:#888;">${latest.time}</span>`;
            assessorElem.innerText = latest.user;
        }

        // --- Logic: Action Dropdown Control ---
        function updateDropdownLogic(historyData) {
            // Reset ค่าเริ่มต้น
            actionState.SPENT = { enabled: true, reason: '' };
            actionState.NAF = { enabled: true, reason: '' };

            // หา SPENT ล่าสุด และ NAF ล่าสุด
            const lastSpent = historyData.find(item => item.type === 'SPENT');
            const lastNaf = historyData.find(item => item.type === 'NAF');

            // --- Condition 1: ยังไม่เคยคัดกรอง SPENT ---
            if (!lastSpent) {
                actionState.SPENT.enabled = true;
                actionState.NAF.enabled = false;
                actionState.NAF.reason = "⚠️ กรุณาทำแบบคัดกรอง SPENT ก่อน";

                renderMenuAndExit(); return;
            }

            // คำนวณวันที่
            const today = new Date();
            const spentDate = parseThaiDate(lastSpent.date);
            const diffTime = Math.abs(today - spentDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const daysLeft = 7 - diffDays;

            // --- Condition 2: คัดกรองแล้ว ผลเป็น "ปกติ" ---
            if (lastSpent.spentResult === 'ปกติ') {
                if (diffDays < 7) {
                    // ล็อก SPENT (เพราะเพิ่งทำ)
                    actionState.SPENT.enabled = false;
                    actionState.SPENT.reason = `ผลปกติ (รออีก ${daysLeft} วัน)`;
                } else {
                    // ครบ 7 วันแล้ว เปิดให้ทำใหม่ได้
                    actionState.SPENT.enabled = true;
                }

                // ล็อก NAF เสมอ เพราะผลปกติ
                actionState.NAF.enabled = false;
                actionState.NAF.reason = "ผลคัดกรองปกติ ไม่จำเป็นต้องทำ NAF";

                renderMenuAndExit(); return;
            }

            // --- Condition 3: คัดกรองแล้ว ผล "มีความเสี่ยง" ---
            // เช็คว่าทำ NAF หรือยัง? (โดยดูว่ามี NAF ที่วันที่ >= วันที่ทำ SPENT หรือไม่)
            let isNafDone = false;
            if (lastNaf) {
                const nafDate = parseThaiDate(lastNaf.date);
                // ถ้าวันที่ทำ NAF ใหม่กว่าหรือเท่ากับ SPENT ถือว่าทำแล้ว
                if (nafDate >= spentDate) {
                    isNafDone = true;
                }
            }

            if (!isNafDone) {
                // >>> เจอความเสี่ยง แต่ยังไม่ทำ NAF <<<

                // ล็อก SPENT (เพื่อบังคับให้ไปทำ NAF ให้จบกระบวนการ)
                actionState.SPENT.enabled = false;
                actionState.SPENT.reason = "พบความเสี่ยง กรุณาประเมิน NAF ให้เสร็จสิ้น";

                // เปิด NAF
                actionState.NAF.enabled = true;

            } else {
                // >>> ทำครบแล้ว (เสี่ยง -> NAF แล้ว) <<<

                // เช็คระยะเวลา 7 วัน จาก SPENT ล่าสุด
                if (diffDays < 7) {
                    actionState.SPENT.enabled = false;
                    actionState.SPENT.reason = `ทำรายการครบแล้ว (รออีก ${daysLeft} วัน)`;
                } else {
                    actionState.SPENT.enabled = true;
                }

                // ล็อก NAF (ต้องเริ่มที่ SPENT รอบใหม่ก่อนเสมอ)
                actionState.NAF.enabled = false;
                actionState.NAF.reason = "กรุณาเริ่มคัดกรอง SPENT รอบใหม่";
            }

            renderMenuAndExit();
        }

        // Helper function เพื่อลดการเขียนซ้ำ
        function renderMenuAndExit() {
            renderMenuState('menu_spent', actionState.SPENT);
            renderMenuState('menu_naf', actionState.NAF);
        }

        function renderMenuState(elementId, state) {
            const el = document.getElementById(elementId);
            if (!el) return;
            const reasonEl = el.querySelector('.reason-text');

            if (!state.enabled) {
                el.classList.add('disabled-action');
                if (reasonEl) {
                    reasonEl.innerText = state.reason;
                    reasonEl.classList.remove('d-none');
                }
            } else {
                el.classList.remove('disabled-action');
                if (reasonEl) {
                    reasonEl.innerText = '';
                    reasonEl.classList.add('d-none');
                }
            }
        }

        function handleAction(type, url) {
            if (actionState[type].enabled) {
                window.location.href = url;
            } else {
                console.log("Action Disabled: " + actionState[type].reason);
            }
        }

        // Helper to parse Thai Date (e.g. "22 ธ.ค. 67")
        function parseThaiDate(dateStr) {
            const thaiMonths = {
                'ม.ค.': 0, 'ก.พ.': 1, 'มี.ค.': 2, 'เม.ย.': 3, 'พ.ค.': 4, 'มิ.ย.': 5,
                'ก.ค.': 6, 'ส.ค.': 7, 'ก.ย.': 8, 'ต.ค.': 9, 'พ.ย.': 10, 'ธ.ค.': 11
            };
            const parts = dateStr.split(' ');
            if (parts.length < 3) return new Date();

            const day = parseInt(parts[0]);
            const month = thaiMonths[parts[1]] !== undefined ? thaiMonths[parts[1]] : 0;
            let year = parseInt(parts[2]);
            // Convert 67 -> 2024 (approx)
            year = (year + 2500) - 543;

            return new Date(year, month, day);
        }

        function confirmLogout() {
            if (confirm('ยืนยันการออกจากระบบ?')) window.location.href = 'index.html';
        }
    </script>
</body>

</html>