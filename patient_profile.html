<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลผู้ป่วย | โรงพยาบาลกำแพงเพชร</title>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

    <style>
        body {
            font-family: "Sarabun", sans-serif;
            background-color: #f4f7f6;
            color: #333;
            padding-top: 80px;
        }

        /* Navbar Styling */
        .navbar-custom {
            height: 80px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .04);
        }

        .brand-logo {
            height: 45px;
            width: auto;
        }

        .brand-text h1 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 0;
            line-height: 1.1;
        }

        .brand-text small {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* User Profile Styling */
        .user-profile-btn {
            display: flex;
            align-items: center;
            padding: 5px 15px 5px 5px;
            border: 1px solid #eee;
            border-radius: 12px;
            background-color: #fff;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .user-profile-btn:hover,
        .show>.user-profile-btn {
            background-color: #f8f9fa;
            border-color: #e2e6ea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .user-avatar {
            width: 38px;
            height: 38px;
            background-color: #2C3E50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .user-info {
            margin-left: 10px;
            margin-right: 15px;
            line-height: 1.2;
            text-align: left;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }

        .user-role {
            font-size: 0.75rem;
            color: #888;
        }

        .dropdown-toggle::after {
            display: none;
        }

        /* --- HIS Standard Style (Card) --- */
        .his-container {
            background-color: #fff;
            border: 1px solid #c8c8c8;
            border-left: 6px solid #999;
            border-radius: 4px;
            padding: 20px 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
        }

        .his-result {
            font-size: 1.6rem;
            font-weight: 700;
            line-height: 1.2;
            color: #2c3e50;
        }

        /* Status Colors */
        .his-normal {
            border-left-color: #28a745 !important;
        }

        .text-his-normal {
            color: #218838;
        }

        .his-risk {
            border-left-color: #ffc107 !important;
        }

        .text-his-risk {
            color: #d39e00;
        }

        .his-severe {
            border-left-color: #dc3545 !important;
        }

        .text-his-severe {
            color: #c82333;
        }

        /* --- Dashboard Layout --- */
        @media (min-width: 768px) {
            .border-right-md {
                border-right: 1px solid #eee;
            }
        }

        /* Score Circle */
        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #fff;
            border: 5px solid #e9ecef;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
            margin: 0 auto;
        }

        .his-risk .score-circle {
            border-color: #ffecd1;
            color: #d39e00;
        }

        .his-severe .score-circle {
            border-color: #f8d7da;
            color: #c82333;
        }

        .his-normal .score-circle {
            border-color: #d4edda;
            color: #155724;
        }

        /* --- Clinical Action Box (Official Notice Style) --- */
        .clinical-action-box {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-left-width: 5px;
            /* แถบสีด้านซ้าย */
            border-radius: 6px;
            padding: 15px;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
        }

        .clinical-action-icon {
            font-size: 1.4rem;
            margin-right: 15px;
            opacity: 0.9;
            flex-shrink: 0;
        }

        .clinical-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clinical-desc {
            font-size: 0.9rem;
            color: #555;
            margin: 0;
            line-height: 1.4;
        }

        /* เพิ่มใน <style> */
        .border-right-md {
            border-right: 1px solid #f0f0f0;
        }

        @media (max-width: 767px) {
            .border-right-md {
                border-right: none;
                border-bottom: 1px solid #f0f0f0;
            }

            .d-flex.align-items-start.mb-3 {
                flex-direction: row;
            }
        }

        /* ปรับแต่งส่วนคะแนนใน layout ใหม่ */
        .score-circle {
            /* สีขอบจะเปลี่ยนตาม Class แม่ (his-risk, his-normal) อัตโนมัติจาก CSS เดิม */
            transition: all 0.3s;
        }

        /* Theme Colors for Action Box */
        .status-urgent {
            border-left-color: #c0392b;
        }

        .status-urgent .clinical-action-icon {
            color: #c0392b;
        }

        .status-urgent .clinical-title {
            color: #922b21;
        }

        .status-normal {
            border-left-color: #27ae60;
        }

        .status-normal .clinical-action-icon {
            color: #27ae60;
        }

        .status-normal .clinical-title {
            color: #1e8449;
        }

        .status-info {
            border-left-color: #2980b9;
        }

        .status-info .clinical-action-icon {
            color: #2980b9;
        }

        .status-info .clinical-title {
            color: #1a5276;
        }

        .status-overdue {
            border-left-color: #e67e22;
        }

        .status-overdue .clinical-action-icon {
            color: #e67e22;
        }

        .status-overdue .clinical-title {
            color: #d35400;
        }

        /* General */
        .patient-icon-box {
            width: 120px;
            height: 150px;
            background-color: #e3f2fd;
            color: #2C3E50;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            border: 1px solid #bbdefb;
        }

        .badge-status-normal {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .badge-status-risk {
            background-color: #fff8e1;
            color: #f57c00;
        }

        .badge-status-severe {
            background-color: #ffebee;
            color: #c62828;
        }

        .doc-link {
            color: #3498DB;
            font-weight: 600;
            text-decoration: none;
        }

        .doc-link:hover {
            text-decoration: underline;
        }

        .disabled-action {
            background-color: #f8f9fa;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .disabled-action * {
            color: #adb5bd !important;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-md navbar-light fixed-top navbar-custom border-bottom">
        <div class="container-fluid px-lg-4">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="img/logo_kph.jpg" class="brand-logo mr-2 d-none d-sm-block" alt="Logo"
                    onerror="this.style.display='none'">
                <div class="brand-text">
                    <h1>ระบบประเมินภาวะโภชนาการ</h1>
                    <small>Nutrition Alert System (NAS)</small>
                </div>
            </a>

            <ul class="navbar-nav ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link p-0" href="#" id="userDropdown" role="button" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false" style="min-width: 250px;">
                        <div class="user-profile-btn">
                            <div class="user-avatar">
                                <i class="fa-solid fa-user-doctor"></i>
                            </div>
                            <div class="user-info d-none d-md-block" style="flex-grow: 1;">
                                <div class="user-name">เพชรลดา เชยเพ็ชร</div>
                                <div class="user-role">นักโภชนาการ</div>
                            </div>
                            <i class="fa-solid fa-chevron-down text-muted mr-2" style="font-size: 0.8rem;"></i>
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow border-0 mt-2" aria-labelledby="userDropdown"
                        style="border-radius: 12px; min-width: 250px;">

                        <div class="dropdown-header bg-light border-bottom py-3">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar mr-3" style="width: 42px; height: 42px; font-size: 1.2rem;">
                                    <i class="fa-solid fa-user-doctor"></i>
                                </div>
                                <div style="line-height: 1.3;">
                                    <strong class="text-dark d-block" style="font-size: 0.95rem;">เพชรลดา
                                        เชยเพ็ชร</strong>
                                    <small class="text-muted">นักโภชนาการชำนาญการ</small>
                                    <br>
                                    <span class="badge badge-info mt-1"
                                        style="font-weight: normal; font-size: 0.7rem;">License: DT-66099</span>
                                </div>
                            </div>
                        </div>

                        <div class="p-2">
                            <h6 class="dropdown-header text-uppercase text-muted small font-weight-bold pl-2 mb-1">
                                งานของฉัน</h6>
                            <a class="dropdown-item py-2 rounded d-flex justify-content-between align-items-center"
                                href="#">
                                <span><i class="fa-solid fa-clipboard-user mr-2 text-primary"
                                        style="width:20px; text-align:center;"></i> ผู้ป่วยที่รับผิดชอบ</span>
                                <span class="badge badge-danger badge-pill">5</span>
                            </a>
                            <a class="dropdown-item py-2 rounded" href="#">
                                <span><i class="fa-solid fa-comment-medical mr-2 text-success"
                                        style="width:20px; text-align:center;"></i> จัดการข้อความด่วน</span>
                            </a>
                            <a class="dropdown-item py-2 rounded" href="#">
                                <span><i class="fa-solid fa-clock-rotate-left mr-2 text-secondary"
                                        style="width:20px; text-align:center;"></i> ประวัติการประเมิน</span>
                            </a>
                        </div>

                        <div class="dropdown-divider m-0"></div>

                        <div class="p-2">
                            <a class="dropdown-item py-2 rounded" href="#">
                                <i class="fa-solid fa-file-signature mr-2 text-warning"
                                    style="width:20px; text-align:center;"></i> ตั้งค่าลายเซ็น (E-Sign)
                            </a>
                        </div>

                        <div class="dropdown-divider m-0"></div>

                        <div class="p-2">
                            <a class="dropdown-item py-2 rounded text-danger" href="#" onclick="confirmLogout()">
                                <i class="fa-solid fa-right-from-bracket mr-2"
                                    style="width:20px; text-align:center;"></i>
                                ออกจากระบบ
                            </a>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid px-lg-5 mt-4">

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-auto">
                        <div class="patient-icon-box"><i class="fa-solid fa-user-injured"></i></div>
                    </div>
                    <div class="col">
                        <h5 class="text-primary-custom font-weight-bold mb-3 border-bottom pb-2 d-inline-block">
                            <i class="fa-solid fa-hospital-user mr-2"></i>ข้อมูลผู้ป่วย
                        </h5>
                        <div class="row">
                            <div class="col-6 col-md-3 col-lg-2 mb-3">
                                <small class="text-muted d-block">HN</small>
                                <span class="font-weight-bold" id="p_hn">-</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 mb-3">
                                <small class="text-muted d-block">AN</small>
                                <span class="font-weight-bold" id="p_an">-</span>
                            </div>
                            <div class="col-12 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">ชื่อ - นามสกุล</small>
                                <span class="font-weight-bold text-primary-custom" id="p_name"
                                    style="font-size: 1.1rem;">-</span>
                            </div>
                            <div class="col-6 col-md-4 col-lg-2 mb-3">
                                <small class="text-muted d-block">อายุ</small>
                                <span class="font-weight-bold" id="p_age">-</span>
                            </div>
                            <div class="col-6 col-md-8 col-lg-2 mb-3">
                                <small class="text-muted d-block">สิทธิการรักษา</small>
                                <span class="font-weight-bold" id="p_rights">-</span>
                            </div>
                            <div class="col-12 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">แพทย์เจ้าของไข้</small>
                                <span class="font-weight-bold" id="p_doctor">-</span>
                            </div>
                            <div class="col-6 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">หอผู้ป่วย / เตียง</small>
                                <span class="font-weight-bold" id="p_ward">-</span>
                            </div>
                            <div class="col-6 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">วันที่ Admit</small>
                                <span class="font-weight-bold" id="p_admit">-</span>
                            </div>
                            <div class="col-6 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">เบอร์โทรศัพท์</small>
                                <span class="font-weight-bold" id="p_phone">-</span>
                            </div>
                            <div class="col-12 col-md-6 col-lg-3 mb-3">
                                <small class="text-muted d-block">โรคประจำตัว</small>
                                <span class="font-weight-bold" id="p_underlying">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="index.html" class="btn btn-outline-secondary btn-sm" style="border-radius: 4px;">
                <i class="fa-solid fa-chevron-left mr-1"></i> กลับหน้าหลัก
            </a>
            <div class="btn-group">
                <button type="button" class="btn btn-primary px-4 shadow-sm dropdown-toggle" data-toggle="dropdown"
                    style="background-color: #0d47a1; border-color: #0d47a1; border-radius: 4px; height: 45px; font-size: 1rem;">
                    <i class="fa-solid fa-folder-plus mr-2"></i> เพิ่มไฟล์เอกสารใหม่
                </button>
                <div class="dropdown-menu dropdown-menu-right border shadow-sm p-0 mt-1"
                    style="min-width: 380px; border-radius: 4px; border-color: #ced4da;">
                    <div class="bg-light px-3 py-2 border-bottom">
                        <small class="text-uppercase text-muted font-weight-bold" style="font-size: 0.75rem;">
                            เลือกประเภทเอกสาร
                        </small>
                    </div>
                    <a href="#" class="dropdown-item py-3 px-3 menu-action-link border-bottom" id="menu_spent"
                        onclick="handleAction('SPENT', 'nutrition_screening_form.html')">
                        <div class="d-flex">
                            <div class="mr-3 d-flex align-items-center justify-content-center icon-box"
                                style="width: 45px; height: 45px; background-color: #f1f8ff; border: 1px solid #d0e2f5; border-radius: 4px; color: #0d47a1;">
                                <i class="fa-solid fa-file-medical fa-lg"></i>
                            </div>
                            <div class="w-100">
                                <span class="font-weight-bold text-dark title-text"
                                    style="font-size: 1rem;">แบบคัดกรองภาวะโภชนาการ</span>
                                <small class="text-muted sub-text d-block mb-1">SPENT Nutrition Screening Tool</small>
                                <div class="reason-text d-none mt-1"
                                    style="font-size: 0.75rem; background-color: #fff5f5; color: #c00; border: 1px solid #fcc; padding: 4px 8px; border-radius: 2px;">
                                </div>
                            </div>
                        </div>
                    </a>
                    <a href="#" class="dropdown-item py-3 px-3 menu-action-link" id="menu_naf"
                        onclick="handleAction('NAF', 'nutrition_alert_form.html')">
                        <div class="d-flex">
                            <div class="mr-3 d-flex align-items-center justify-content-center icon-box"
                                style="width: 45px; height: 45px; background-color: #f1f8ff; border: 1px solid #d0e2f5; border-radius: 4px; color: #0d47a1;">
                                <i class="fa-solid fa-clipboard-user fa-lg"></i>
                            </div>
                            <div class="w-100">
                                <span class="font-weight-bold text-dark title-text"
                                    style="font-size: 1rem;">แบบประเมินภาวะโภชนาการ</span>
                                <small class="text-muted sub-text d-block mb-1">Nutrition Alert Form (NAF)</small>
                                <div class="reason-text d-none mt-1"
                                    style="font-size: 0.75rem; background-color: #fff5f5; color: #c00; border: 1px solid #fcc; padding: 4px 8px; border-radius: 2px;">
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <div id="currentStatusCard" class="his-container d-none p-0 overflow-hidden">
            <div class="row no-gutters">

                <div class="col-md-8 p-4 d-flex flex-column border-right-md">

                    <div class="d-flex align-items-center justify-content-between mb-3 pb-2 border-bottom">
                        <h6 class="font-weight-bold m-0 text-primary-custom">
                            <i class="fa-solid fa-clipboard-check mr-2"></i>สถานะโภชนาการปัจจุบัน
                        </h6>
                        <span id="cur_source_badge"
                            class="badge badge-light border text-muted font-weight-normal px-2">-</span>
                    </div>

                    <div class="d-flex align-items-start mb-3">
                        <div class="flex-grow-1 pr-3">
                            <small class="text-uppercase text-muted font-weight-bold" id="cur_type_label"
                                style="font-size: 0.75rem;">-</small>
                            <h4 id="cur_status_text" class="his-result mt-1 mb-2" style="font-size: 1.5rem;">-</h4>
                            <p id="cur_status_desc" class="text-muted" style="font-size: 0.95rem; line-height: 1.5;">-
                            </p>
                        </div>

                        <div class="text-center pl-3 border-left">
                            <div class="score-circle shadow-sm bg-white mx-auto mb-1"
                                style="width: 60px; height: 60px; font-size: 1.6rem;">
                                <span id="cur_score_val">-</span>
                            </div>
                            <small class="text-muted font-weight-bold" style="font-size: 0.7rem;">คะแนนรวม</small>
                        </div>
                    </div>

                    <div class="mt-auto">
                        <div class="d-flex align-items-center bg-light rounded p-2" style="font-size: 0.85rem;">
                            <div class="mr-4 d-flex align-items-center">
                                <i class="fa-regular fa-calendar text-muted mr-2"></i>
                                <span id="cur_date_text" class="font-weight-medium text-dark">-</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-user-nurse text-muted mr-2"></i>
                                <span id="cur_assessor_text" class="font-weight-medium text-dark">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 p-4 d-flex flex-column justify-content-center bg-white">
                    <div class="w-100">
                        <h6 class="text-muted font-weight-bold text-uppercase mb-3"
                            style="font-size: 0.75rem; letter-spacing: 1px;">
                            สิ่งดำเนินการถัดไป (Next Action)
                        </h6>
                        <div id="cur_next_action" class="w-100"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card border shadow-sm mb-5">
            <div class="card-header bg-white py-3 d-flex flex-wrap justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary-custom">
                    <i class="fa-solid fa-clock-rotate-left mr-2"></i> ประวัติการบันทึกข้อมูลทั้งหมด
                </h6>
                <div class="form-inline mt-2 mt-md-0">
                    <label class="small text-muted mr-2"><i class="fa-solid fa-filter"></i> กรองข้อมูล:</label>
                    <select id="typeFilter" class="form-control form-control-sm custom-select" onchange="filterTable()">
                        <option value="all">ทั้งหมด (All)</option>
                        <option value="NAF">แบบประเมิน (NAF)</option>
                        <option value="SPENT">แบบคัดกรอง (SPENT)</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0"> 
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 20%;">รายการบันทึก</th>
                                <th class="text-center" style="width: 8%;">ประเภท</th>
                                <th class="text-center" style="width: 5%;">คะแนน</th>
                                <th style="width: 12%;">ผลการคัดกรอง</th>
                                <th style="width: 12%;">ผลการประเมิน</th>
                                <th style="width: 12%;">ผู้ประเมิน</th>
                                <th style="width: 10%;">วันเวลาที่บันทึก</th>
                                <th style="width: 10%;">วันเวลาที่แก้ไข</th>
                                <th class="text-center" style="width: 6%;">เอกสาร</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
                <div id="noDataMessage" class="text-center py-5 d-none">
                    <p class="text-muted mb-0">ยังไม่มีประวัติการบันทึกข้อมูล</p>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>

    <script>
        // --- 1. Mock Data ---
        const now = new Date();
        const thMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
        const d = now.getDate();
        const m = thMonths[now.getMonth()];
        const y = (now.getFullYear() + 543) - 2500;
        const todayStr = `${d} ${m} ${y}`;

        const patientsData = {
            '6601122': {
                // มานี: SPENT ครั้งที่ 1 -> NAF ครั้งที่ 1
                info: { hn: '6601122', an: '6700450', name: 'นางสาวมานี มีนา', age: '30 ปี', rights: 'บัตรทอง', underlying: 'ปฏิเสธโรคประจำตัว', doctor: 'พญ. ใจดี มีเมตตา', ward: 'อายุรกรรมหญิง / 106', admit: '20 ธ.ค. 67 10:00 น.', phone: '089-999-9999' },
                history: [
                    { type: 'NAF', ref: 'NAF-671223-001', score: 8, spentResult: '-', nafResult: 'ปานกลาง (NAF B)', user: 'เพชรลดา เชยเพ็ชร', date: todayStr, time: '11:00 น.', edit: '-' },
                    { type: 'SPENT', ref: 'SP-671223-001', score: 3, spentResult: 'มีความเสี่ยง', nafResult: '-', user: 'เพชรลดา เชยเพ็ชร', date: todayStr, time: '10:45 น.', edit: '-' }
                ]
            },
            '6604589': {
                // สมชาย: เคยทำ SPENT มาก่อน (ครั้งที่ 1) และวันนี้ทำอีกรอบ (ครั้งที่ 2)
                info: { hn: '6604589', an: '6700123', name: 'นายสมชาย ใจดี', age: '45 ปี', rights: 'บัตรทอง', underlying: 'ความดันโลหิตสูง (HT)', doctor: 'นพ. สมศักดิ์ รักษาดี', ward: 'อายุรกรรมชาย 1 / 101', admit: '15 พ.ย. 67 08:30 น.', phone: '081-111-1111' },
                history: [
                    // อันใหม่ (จะเป็นครั้งที่ 2)
                    { type: 'SPENT', ref: 'SP-TEST-002', score: 1, spentResult: 'ปกติ', nafResult: '-', user: 'ทดสอบ ระบบ', date: todayStr, time: '10:00 น.', edit: '-' },
                    // อันเก่า (จะเป็นครั้งที่ 1)
                    { type: 'SPENT', ref: 'SP-TEST-001', score: 0, spentResult: 'ปกติ', nafResult: '-', user: 'เพชรลดา เชยเพ็ชร', date: '1 พ.ย. 67', time: '09:00 น.', edit: '-' }
                ]
            },
            '6603321': {
                // วิชัย
                info: { hn: '6603321', an: '6700189', name: 'นายวิชัย กล้าหาญ', age: '75 ปี', rights: 'ประกันสังคม', underlying: 'ไขมันในเลือดสูง (DLP)', doctor: 'นพ. เก่งกาจ วิชาการ', ward: 'อายุรกรรมชาย 1 / 103', admit: '18 พ.ย. 67 14:20 น.', phone: '083-333-3333' },
                history: [
                    { type: 'SPENT', ref: 'SP-OLD', score: 3, spentResult: 'มีความเสี่ยง', nafResult: '-', user: 'เพชรลดา เชยเพ็ชร', date: '1 ต.ค. 67', time: '14:30 น.', edit: '-' }
                ]
            },
            '6609888': {
                // มั่นคง
                info: { hn: '6609888', an: '6700300', name: 'นายมั่นคง ทรงพลัง', age: '55 ปี', rights: 'ชำระเงินเอง', underlying: 'ปฏิเสธโรคประจำตัว', doctor: 'นพ. เชี่ยวชาญ งานละเอียด', ward: 'ศัลยกรรมกระดูก 3 / 105', admit: '10 พ.ย. 67 20:45 น.', phone: '084-444-4444' },
                history: [
                    { type: 'SPENT', ref: 'SP-671110-001', score: 0, spentResult: 'ปกติ', nafResult: '-', user: 'เพชรลดา เชยเพ็ชร', date: '10 พ.ย. 67', time: '21:00 น.', edit: '-' }
                ]
            },
            '6605112': {
                // สมหญิง
                info: { hn: '6605112', an: '6700145', name: 'นางสมหญิง รักเรียน', age: '62 ปี', rights: 'ข้าราชการ', underlying: 'เบาหวาน (DM), โรคไต (CKD)', doctor: 'พญ. ใจดี มีเมตตา', ward: 'อายุรกรรมหญิง 2 / 102', admit: '25 พ.ย. 67 10:15 น.', phone: '082-222-2222' },
                history: []
            }
        };

        let actionState = { SPENT: { enabled: true, reason: '' }, NAF: { enabled: true, reason: '' } };

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            let hn = urlParams.get('hn');
            if (!hn || !patientsData[hn]) { hn = '6601122'; } // Default

            if (hn && patientsData[hn]) {
                const p = patientsData[hn];

                // Render Patient Info
                document.getElementById('p_hn').innerText = p.info.hn;
                document.getElementById('p_an').innerText = p.info.an;
                document.getElementById('p_name').innerText = p.info.name;
                document.getElementById('p_age').innerText = p.info.age;
                document.getElementById('p_rights').innerText = p.info.rights;
                document.getElementById('p_underlying').innerText = p.info.underlying;
                document.getElementById('p_doctor').innerText = p.info.doctor;
                document.getElementById('p_ward').innerText = p.info.ward;
                document.getElementById('p_admit').innerText = p.info.admit;
                document.getElementById('p_phone').innerText = p.info.phone;

                // --- LOGIC: จัดเรียงและสร้างชื่อ "ครั้งที่ X" อัตโนมัติ ---

                // 1. เรียงจาก "เก่า -> ใหม่" เพื่อไล่นับเลข (1, 2, 3...)
                let processHistory = p.history.sort((a, b) => {
                    return parseThaiDateTime(a.date, a.time) - parseThaiDateTime(b.date, b.time);
                });

                // ตัวนับ
                let countSPENT = 0;
                let countNAF = 0;

                // วนลูปสร้าง Title
                processHistory.forEach(item => {
                    if (item.type === 'SPENT') {
                        countSPENT++;
                        item.title = `แบบคัดกรองภาวะโภชนาการ (ครั้งที่ ${countSPENT})`;
                    } else if (item.type === 'NAF') {
                        countNAF++;
                        item.title = `แบบประเมินภาวะโภชนาการ (ครั้งที่ ${countNAF})`;
                    }
                });

                // 2. เรียงกลับจาก "ใหม่ -> เก่า" เพื่อแสดงผล (ล่าสุดอยู่บน)
                const finalHistory = processHistory.sort((a, b) => {
                    return parseThaiDateTime(b.date, b.time) - parseThaiDateTime(a.date, a.time);
                });

                renderHistoryTable(finalHistory);
                renderCurrentStatus(finalHistory);
                updateDropdownLogic(finalHistory);

            } else {
                document.getElementById('p_name').innerHTML = '<span class="text-danger">ไม่พบข้อมูลผู้ป่วย</span>';
                document.getElementById('currentStatusCard').classList.add('d-none');
                document.getElementById('noDataMessage').classList.remove('d-none');
            }
        });

        // --- Helper Functions ---

        function renderCurrentStatus(historyData) {
            const card = document.getElementById('currentStatusCard');
            if (!historyData || historyData.length === 0) { card.classList.add('d-none'); return; }
            card.classList.remove('d-none');
            const latest = historyData[0];

            const typeLabelElem = document.getElementById('cur_type_label');
            const statusTextElem = document.getElementById('cur_status_text');
            const statusDescElem = document.getElementById('cur_status_desc');
            const scoreValElem = document.getElementById('cur_score_val');
            const dateTextElem = document.getElementById('cur_date_text');
            const assessorElem = document.getElementById('cur_assessor_text');
            const sourceBadgeElem = document.getElementById('cur_source_badge');
            const nextActionElem = document.getElementById('cur_next_action');

            card.classList.remove('his-normal', 'his-risk', 'his-severe');
            statusTextElem.className = 'his-result';

            let mainThemeClass = ''; let textClass = ''; let statusDesc = '';

            if (latest.type === 'NAF') {
                sourceBadgeElem.innerText = 'อ้างอิง: แบบประเมิน NAF';
                typeLabelElem.innerText = 'ระดับความรุนแรง (Severity)';
                statusTextElem.innerText = latest.nafResult;
                if (latest.nafResult.includes('ปกติ')) {
                    mainThemeClass = 'his-normal'; textClass = 'text-his-normal'; statusDesc = 'ภาวะโภชนาการปกติ ให้การดูแลตามมาตรฐาน';
                } else if (latest.nafResult.includes('ปานกลาง')) {
                    mainThemeClass = 'his-risk'; textClass = 'text-his-risk'; statusDesc = 'มีความเสี่ยงระดับปานกลาง ควรติดตามต่อเนื่อง';
                } else {
                    mainThemeClass = 'his-severe'; textClass = 'text-his-severe'; statusDesc = 'มีภาวะทุพโภชนาการรุนแรง ต้องการการดูแลเร่งด่วน';
                }
            } else {
                sourceBadgeElem.innerText = 'อ้างอิง: แบบคัดกรอง SPENT';
                typeLabelElem.innerText = 'ผลการคัดกรองความเสี่ยง';
                statusTextElem.innerText = latest.spentResult;

                if (latest.spentResult === 'ปกติ') {
                    mainThemeClass = 'his-normal'; textClass = 'text-his-normal'; statusDesc = 'ไม่พบความเสี่ยงในขณะนี้';
                } else {
                    mainThemeClass = 'his-risk'; textClass = 'text-his-risk'; statusDesc = 'มีความเสี่ยงต่อภาวะทุพโภชนาการ';
                }
            }

            card.classList.add(mainThemeClass);
            statusTextElem.classList.add(textClass);
            scoreValElem.innerText = latest.score;
            statusDescElem.innerText = statusDesc;
            dateTextElem.innerText = latest.date + ' ' + latest.time;
            assessorElem.innerText = latest.user;

            renderNextAction(historyData, nextActionElem);
        }

        function renderNextAction(historyData, containerElem) {
            let actionThemeClass = ''; let iconClass = ''; let titleText = ''; let descText = ''; let refText = '';
            const lastSpent = historyData.find(item => item.type === 'SPENT');
            const lastNaf = historyData.find(item => item.type === 'NAF');
            let diffDays = 0; let daysLeft = 0;

            if (lastSpent) {
                const today = new Date();
                const spentDate = parseThaiDateTime(lastSpent.date, lastSpent.time);
                const diffTime = Math.abs(today - spentDate);
                diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                daysLeft = 7 - diffDays;
                if (daysLeft < 0) daysLeft = 0;
            }

            if (!lastSpent) {
                actionThemeClass = 'status-info'; iconClass = 'fa-clipboard-list'; titleText = 'New Patient'; descText = 'เริ่มทำแบบคัดกรอง SPENT'; refText = 'ยังไม่มีประวัติการคัดกรอง';
            } else if (lastSpent.spentResult === 'ปกติ') {
                refText = `อ้างอิง: ผล SPENT ปกติ (${lastSpent.date})`;
                if (diffDays < 7) {
                    actionThemeClass = 'status-normal'; iconClass = 'fa-clock'; titleText = 'Monitoring'; descText = `รอคัดกรองซ้ำในอีก ${daysLeft} วัน`;
                } else {
                    actionThemeClass = 'status-overdue'; iconClass = 'fa-bell'; titleText = 'Overdue'; descText = 'ครบกำหนด 7 วัน กรุณาทำแบบคัดกรองใหม่';
                }
            } else {
                let isNafDone = false;
                if (lastNaf) {
                    const spentDate = parseThaiDateTime(lastSpent.date, lastSpent.time);
                    const nafDate = parseThaiDateTime(lastNaf.date, lastNaf.time);
                    if (nafDate >= spentDate) isNafDone = true;
                }
                if (!isNafDone) {
                    actionThemeClass = 'status-urgent'; iconClass = 'fa-user-doctor'; titleText = 'Action Required'; descText = 'พบความเสี่ยง! ต้องประเมิน NAF ทันที'; refText = `อ้างอิง: พบความเสี่ยง SPENT (${lastSpent.date})`;
                } else {
                    refText = `อ้างอิง: ประเมิน NAF เรียบร้อย (${lastNaf.date})`;
                    if (diffDays < 7) {
                        actionThemeClass = 'status-info'; iconClass = 'fa-check-circle'; titleText = 'Completed'; descText = 'บันทึกผลเรียบร้อย รอติดตามอาการตามรอบ';
                    } else {
                        actionThemeClass = 'status-overdue'; iconClass = 'fa-circle-exclamation'; titleText = 'Overdue'; descText = 'ครบกำหนดติดตามอาการ กรุณาเริ่มกระบวนการใหม่';
                    }
                }
            }
            containerElem.innerHTML = `<div class="clinical-action-box ${actionThemeClass}"><div class="d-flex align-items-start w-100"><div class="clinical-action-icon pt-1"><i class="fa-solid ${iconClass}"></i></div><div class="clinical-action-content w-100"><div class="clinical-title">${titleText}</div><p class="clinical-desc">${descText}</p>${refText ? `<div class="mt-2 pt-2 border-top" style="border-color: rgba(0,0,0,0.08) !important;"><small class="text-muted font-weight-bold" style="font-size: 0.75rem; letter-spacing: 0.3px;"><i class="fa-solid fa-file-signature mr-1"></i> ${refText}</small></div>` : ''}</div></div></div>`;
        }

        function updateDropdownLogic(historyData) {
            actionState.SPENT = { enabled: true, reason: '' };
            actionState.NAF = { enabled: true, reason: '' };
            const lastSpent = historyData.find(item => item.type === 'SPENT');
            const lastNaf = historyData.find(item => item.type === 'NAF');

            if (!lastSpent) {
                actionState.NAF.enabled = false; actionState.NAF.reason = "⚠️ กรุณาทำแบบคัดกรอง SPENT ก่อน";
                renderMenuAndExit(); return;
            }

            const today = new Date();
            const spentDate = parseThaiDateTime(lastSpent.date, lastSpent.time);
            const diffTime = Math.abs(today - spentDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const daysLeft = 7 - diffDays;

            if (lastSpent.spentResult === 'ปกติ') {
                if (diffDays < 7) { actionState.SPENT.enabled = false; actionState.SPENT.reason = `⚠️ ผลปกติ (รออีก ${daysLeft} วัน)`; }
                actionState.NAF.enabled = false; actionState.NAF.reason = "⚠️ ผลปกติ ไม่ต้องทำ NAF";
                renderMenuAndExit(); return;
            }
            let isNafDone = false;
            if (lastNaf) {
                const nafDate = parseThaiDateTime(lastNaf.date, lastNaf.time);
                if (nafDate >= spentDate) isNafDone = true;
            }
            if (!isNafDone) {
                actionState.SPENT.enabled = false; actionState.SPENT.reason = "⚠️ พบความเสี่ยง ต้องทำ NAF";
                actionState.NAF.enabled = true;
            } else {
                if (diffDays < 7) { actionState.SPENT.enabled = false; actionState.SPENT.reason = `⚠️ ทำรายการครบแล้ว (รออีก ${daysLeft} วัน)`; }
                actionState.NAF.enabled = false; actionState.NAF.reason = "⚠️ กรุณาเริ่มคัดกรองใหม่";
            }
            renderMenuAndExit();
        }

        function renderMenuAndExit() { renderMenuState('menu_spent', actionState.SPENT); renderMenuState('menu_naf', actionState.NAF); }
        function renderMenuState(id, state) {
            const el = document.getElementById(id); if (!el) return;
            const rEl = el.querySelector('.reason-text');
            if (!state.enabled) { el.classList.add('disabled-action'); if (rEl) { rEl.innerText = state.reason; rEl.classList.remove('d-none'); } }
            else { el.classList.remove('disabled-action'); if (rEl) { rEl.innerText = ''; rEl.classList.add('d-none'); } }
        }

        function renderHistoryTable(historyData) {
            const tbody = document.getElementById('historyTableBody'); tbody.innerHTML = '';
            if (!historyData || historyData.length === 0) { document.getElementById('noDataMessage').classList.remove('d-none'); return; }

            historyData.forEach(item => {
                // Badge Logic
                let spentBadge = item.spentResult === '-' ? '-' : (item.spentResult === 'ปกติ' ? '<span class="badge badge-status-normal">ปกติ</span>' : '<span class="badge badge-status-risk">มีความเสี่ยง</span>');
                let nafBadge = item.nafResult === '-' ? '-' : (item.nafResult.includes('ปกติ') ? '<span class="badge badge-status-normal">' + item.nafResult + '</span>' : (item.nafResult.includes('ปานกลาง') ? '<span class="badge badge-status-risk">' + item.nafResult + '</span>' : '<span class="badge badge-status-severe">' + item.nafResult + '</span>'));
                let typeBadge = item.type === 'NAF' ? '<span class="badge badge-pill badge-info">NAF</span>' : '<span class="badge badge-pill badge-primary">SPENT</span>';

                // Link
                let targetUrl = (item.type === 'SPENT') ? `nutrition_screening_form.html?ref=${item.ref}&mode=view` : `nutrition_alert_form.html?ref=${item.ref}&mode=view`;

                // Row HTML (เพิ่มคอลัมน์ edit)
                const rowHtml = `
                    <tr data-type="${item.type}">
                        <td><a href="${targetUrl}" class="doc-link">${item.title}</a><div class="small text-muted">Ref: ${item.ref}</div></td>
                        <td class="text-center">${typeBadge}</td>
                        <td class="text-center font-weight-bold">${item.score}</td>
                        <td>${spentBadge}</td>
                        <td>${nafBadge}</td>
                        <td>${item.user}</td>
                        <td>${item.date}<br><small class="text-muted">${item.time}</small></td>
                        <td>${item.edit}</td> <td class="text-center">
                            <a href="${targetUrl}" class="text-danger h5" data-toggle="tooltip" title="ดูเอกสาร PDF">
                                <i class="fa-solid fa-file-pdf"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', rowHtml);
            });
            // Init Tooltips
            $('[data-toggle="tooltip"]').tooltip();
        }

        function handleAction(type, url) { if (actionState[type].enabled) window.location.href = url; }
        function filterTable() {
            var filter = document.getElementById("typeFilter").value;
            var tr = document.getElementById("historyTableBody").getElementsByTagName("tr");
            for (var i = 0; i < tr.length; i++) { tr[i].style.display = (filter === "all" || tr[i].getAttribute("data-type") === filter) ? "" : "none"; }
        }
        function parseThaiDateTime(dateStr, timeStr) {
            const thaiMonths = { 'ม.ค.': 0, 'ก.พ.': 1, 'มี.ค.': 2, 'เม.ย.': 3, 'พ.ค.': 4, 'มิ.ย.': 5, 'ก.ค.': 6, 'ส.ค.': 7, 'ก.ย.': 8, 'ต.ค.': 9, 'พ.ย.': 10, 'ธ.ค.': 11 };
            const parts = dateStr.split(' ');
            if (parts.length < 3) return new Date();
            let year = parseInt(parts[2]);
            year = (year + 2500) - 543;
            const month = thaiMonths[parts[1]] !== undefined ? thaiMonths[parts[1]] : 0;
            const day = parseInt(parts[0]);
            let hours = 0; let minutes = 0;
            if (timeStr) { const timeParts = timeStr.replace(' น.', '').split(':'); if (timeParts.length >= 2) { hours = parseInt(timeParts[0]); minutes = parseInt(timeParts[1]); } }
            return new Date(year, month, day, hours, minutes);
        }
        function confirmLogout() { if (confirm('ยืนยันการออกจากระบบ?')) window.location.href = 'index.html'; }

        // Init Tooltips globally
        $(function () { $('[data-toggle="tooltip"]').tooltip() })
    </script>
</body>

</html>