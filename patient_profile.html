<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ | ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£</title>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

    <style>
        body {
            font-family: "Sarabun", sans-serif;
            background-color: #f4f7f6;
            color: #333;
            padding-top: 80px;
        }

        /* Navbar Styling */
        .navbar-custom {
            height: 80px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .04);
        }

        .brand-logo {
            height: 45px;
            width: auto;
        }

        .brand-text h1 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 0;
            line-height: 1.1;
        }

        .brand-text small {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* User Profile Styling */
        .user-profile-btn {
            display: flex;
            align-items: center;
            padding: 5px 15px 5px 5px;
            border: 1px solid #eee;
            border-radius: 12px;
            background-color: #fff;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .user-profile-btn:hover,
        .show>.user-profile-btn {
            background-color: #f8f9fa;
            border-color: #e2e6ea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .user-avatar {
            width: 38px;
            height: 38px;
            background-color: #2C3E50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .user-info {
            margin-left: 10px;
            margin-right: 15px;
            line-height: 1.2;
            text-align: left;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }

        .user-role {
            font-size: 0.75rem;
            color: #888;
        }

        .dropdown-toggle::after {
            display: none;
        }

        /* --- HIS Standard Style (Card) --- */
        .his-container {
            background-color: #fff;
            border: 1px solid #c8c8c8;
            border-left: 6px solid #999;
            border-radius: 4px;
            padding: 20px 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
        }

        .his-result {
            font-size: 1.6rem;
            font-weight: 700;
            line-height: 1.2;
            color: #2c3e50;
        }

        /* Status Colors */
        .his-normal {
            border-left-color: #28a745 !important;
        }

        .text-his-normal {
            color: #218838;
        }

        .his-risk {
            border-left-color: #ffc107 !important;
        }

        .text-his-risk {
            color: #d39e00;
        }

        .his-severe {
            border-left-color: #dc3545 !important;
        }

        .text-his-severe {
            color: #c82333;
        }

        /* --- Dashboard Layout --- */
        @media (min-width: 768px) {
            .border-right-md {
                border-right: 1px solid #eee;
            }
        }

        /* Score Circle */
        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #fff;
            border: 5px solid #e9ecef;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
            margin: 0 auto;
        }

        .his-risk .score-circle {
            border-color: #ffecd1;
            color: #d39e00;
        }

        .his-severe .score-circle {
            border-color: #f8d7da;
            color: #c82333;
        }

        .his-normal .score-circle {
            border-color: #d4edda;
            color: #155724;
        }

        /* --- Clinical Action Box (Official Notice Style) --- */
        .clinical-action-box {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-left-width: 5px;
            /* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
            border-radius: 6px;
            padding: 15px;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
        }

        .clinical-action-icon {
            font-size: 1.4rem;
            margin-right: 15px;
            opacity: 0.9;
            flex-shrink: 0;
        }

        .clinical-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clinical-desc {
            font-size: 0.9rem;
            color: #555;
            margin: 0;
            line-height: 1.4;
        }

        .border-right-md {
            border-right: 1px solid #f0f0f0;
        }

        @media (max-width: 767px) {
            .border-right-md {
                border-right: none;
                border-bottom: 1px solid #f0f0f0;
            }

            .d-flex.align-items-start.mb-3 {
                flex-direction: row;
            }
        }

        .score-circle {
            transition: all 0.3s;
        }

        /* Theme Colors for Action Box */
        .status-urgent {
            border-left-color: #c0392b;
        }

        .status-urgent .clinical-action-icon {
            color: #c0392b;
        }

        .status-urgent .clinical-title {
            color: #922b21;
        }

        .status-normal {
            border-left-color: #27ae60;
        }

        .status-normal .clinical-action-icon {
            color: #27ae60;
        }

        .status-normal .clinical-title {
            color: #1e8449;
        }

        .status-info {
            border-left-color: #2980b9;
        }

        .status-info .clinical-action-icon {
            color: #2980b9;
        }

        .status-info .clinical-title {
            color: #1a5276;
        }

        .status-overdue {
            border-left-color: #e67e22;
        }

        .status-overdue .clinical-action-icon {
            color: #e67e22;
        }

        .status-overdue .clinical-title {
            color: #d35400;
        }

        /* General */
        .patient-icon-box {
            width: 120px;
            height: 150px;
            background-color: #e3f2fd;
            color: #2C3E50;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            border: 1px solid #bbdefb;
        }

        .badge-status-normal {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .badge-status-risk {
            background-color: #fff8e1;
            color: #f57c00;
        }

        .badge-status-severe {
            background-color: #ffebee;
            color: #c62828;
        }

        .doc-link {
            color: #3498DB;
            font-weight: 600;
            text-decoration: none;
        }

        .doc-link:hover {
            text-decoration: underline;
        }

        .disabled-action {
            background-color: #f8f9fa;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .disabled-action * {
            color: #adb5bd !important;
        }

        /* Table Customization for 9 Columns */
        .table-custom th {
            font-size: 0.85rem;
            white-space: nowrap;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            vertical-align: middle;
        }

        .table-custom td {
            font-size: 0.9rem;
            vertical-align: middle;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-md navbar-light fixed-top navbar-custom border-bottom">
        <div class="container-fluid px-lg-4">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="img/logo_kph.jpg" class="brand-logo mr-2 d-none d-sm-block" alt="Logo"
                    onerror="this.style.display='none'">
                <div class="brand-text">
                    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</h1>
                    <small>Nutrition Alert System (NAS)</small>
                </div>
            </a>

            <ul class="navbar-nav ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link p-0" href="#" id="userDropdown" role="button" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false" style="min-width: 250px;">
                        <div class="user-profile-btn">
                            <div class="user-avatar">
                                <i class="fa-solid fa-user-doctor"></i>
                            </div>
                            <div class="user-info d-none d-md-block" style="flex-grow: 1;">
                                <div class="user-name">‡πÄ‡∏û‡∏ä‡∏£‡∏•‡∏î‡∏≤ ‡πÄ‡∏ä‡∏¢‡πÄ‡∏û‡πá‡∏ä‡∏£</div>
                                <div class="user-role">‡∏ô‡∏±‡∏Å‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</div>
                            </div>
                            <i class="fa-solid fa-chevron-down text-muted mr-2" style="font-size: 0.8rem;"></i>
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow border-0 mt-2" aria-labelledby="userDropdown"
                        style="border-radius: 12px; min-width: 250px;">

                        <div class="dropdown-header bg-light border-bottom py-3">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar mr-3" style="width: 42px; height: 42px; font-size: 1.2rem;">
                                    <i class="fa-solid fa-user-doctor"></i>
                                </div>
                                <div style="line-height: 1.3;">
                                    <strong class="text-dark d-block" style="font-size: 0.95rem;">‡πÄ‡∏û‡∏ä‡∏£‡∏•‡∏î‡∏≤
                                        ‡πÄ‡∏ä‡∏¢‡πÄ‡∏û‡πá‡∏ä‡∏£</strong>
                                    <small class="text-muted">‡∏ô‡∏±‡∏Å‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£</small>
                                    <br>
                                    <span class="badge badge-info mt-1"
                                        style="font-weight: normal; font-size: 0.7rem;">License: DT-66099</span>
                                </div>
                            </div>
                        </div>

                        <div class="p-2">
                            <h6 class="dropdown-header text-uppercase text-muted small font-weight-bold pl-2 mb-1">
                                ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h6>
                            <a class="dropdown-item py-2 rounded d-flex justify-content-between align-items-center"
                                href="#">
                                <span><i class="fa-solid fa-clipboard-user mr-2 text-primary"
                                        style="width:20px; text-align:center;"></i> ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</span>
                                <span class="badge badge-danger badge-pill">5</span>
                            </a>
                            <a class="dropdown-item py-2 rounded" href="#">
                                <span><i class="fa-solid fa-comment-medical mr-2 text-success"
                                        style="width:20px; text-align:center;"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</span>
                            </a>
                            <a class="dropdown-item py-2 rounded" href="#">
                                <span><i class="fa-solid fa-clock-rotate-left mr-2 text-secondary"
                                        style="width:20px; text-align:center;"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</span>
                            </a>
                        </div>

                        <div class="dropdown-divider m-0"></div>

                        <div class="p-2">
                            <a class="dropdown-item py-2 rounded" href="#">
                                <i class="fa-solid fa-file-signature mr-2 text-warning"
                                    style="width:20px; text-align:center;"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (E-Sign)
                            </a>
                        </div>

                        <div class="dropdown-divider m-0"></div>

                        <div class="p-2">
                            <a class="dropdown-item py-2 rounded text-danger" href="#" onclick="confirmLogout()">
                                <i class="fa-solid fa-right-from-bracket mr-2"
                                    style="width:20px; text-align:center;"></i>
                                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                            </a>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid px-lg-5 mt-4">

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-auto">
                        <div class="patient-icon-box"><i class="fa-solid fa-user-injured"></i></div>
                    </div>
                    <div class="col">
                        <h5 class="text-primary-custom font-weight-bold mb-3 border-bottom pb-2 d-inline-block">
                            <i class="fa-solid fa-hospital-user mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                        </h5>
                        <div class="row">
                            <div class="col-6 col-md-3 col-lg-2 mb-3">
                                <small class="text-muted d-block">HN</small>
                                <span class="font-weight-bold" id="p_hn">-</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 mb-3">
                                <small class="text-muted d-block">AN</small>
                                <span class="font-weight-bold" id="p_an">-</span>
                            </div>
                            <div class="col-12 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</small>
                                <span class="font-weight-bold text-primary-custom" id="p_name"
                                    style="font-size: 1.1rem;">-</span>
                            </div>
                            <div class="col-6 col-md-4 col-lg-2 mb-3">
                                <small class="text-muted d-block">‡∏≠‡∏≤‡∏¢‡∏∏</small>
                                <span class="font-weight-bold" id="p_age">-</span>
                            </div>
                            <div class="col-6 col-md-8 col-lg-2 mb-3">
                                <small class="text-muted d-block">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</small>
                                <span class="font-weight-bold" id="p_rights">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</span>
                            </div>
                            <div class="col-12 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏Ç‡πâ</small>
                                <span class="font-weight-bold" id="p_doctor">-</span>
                            </div>
                            <div class="col-6 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ / ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</small>
                                <span class="font-weight-bold" id="p_ward">-</span>
                            </div>
                            <div class="col-6 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Admit</small>
                                <span class="font-weight-bold" id="p_admit">-</span>
                            </div>
                            <div class="col-6 col-md-6 col-lg-2 mb-3">
                                <small class="text-muted d-block">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</small>
                                <span class="font-weight-bold" id="p_phone">-</span>
                            </div>
                            <div class="col-12 col-md-6 col-lg-3 mb-3">
                                <small class="text-muted d-block">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</small>
                                <span class="font-weight-bold" id="p_underlying">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="index.html" class="btn btn-outline-secondary btn-sm" style="border-radius: 4px;">
                <i class="fa-solid fa-chevron-left mr-1"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
            <div class="btn-group">
                <button type="button" class="btn btn-primary px-4 shadow-sm dropdown-toggle" data-toggle="dropdown"
                    style="background-color: #0d47a1; border-color: #0d47a1; border-radius: 4px; height: 45px; font-size: 1rem;">
                    <i class="fa-solid fa-folder-plus mr-2"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                </button>
                <div class="dropdown-menu dropdown-menu-right border shadow-sm p-0 mt-1"
                    style="min-width: 380px; border-radius: 4px; border-color: #ced4da;">
                    <div class="bg-light px-3 py-2 border-bottom">
                        <small class="text-uppercase text-muted font-weight-bold" style="font-size: 0.75rem;">
                            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                        </small>
                    </div>

                    <a href="javascript:void(0)" class="dropdown-item py-3 px-3 menu-action-link border-bottom"
                        id="menu_spent" onclick="handleAction('SPENT', 'nutrition_screening_form.html')">
                        <div class="d-flex">
                            <div class="mr-3 d-flex align-items-center justify-content-center icon-box"
                                style="width: 45px; height: 45px; background-color: #f1f8ff; border: 1px solid #d0e2f5; border-radius: 4px; color: #0d47a1;">
                                <i class="fa-solid fa-file-medical fa-lg"></i>
                            </div>
                            <div class="w-100">
                                <span class="font-weight-bold text-dark title-text"
                                    style="font-size: 1rem;">‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</span>
                                <small class="text-muted sub-text d-block mb-1">SPENT Nutrition Screening Tool</small>
                                <div class="reason-text d-none mt-1"
                                    style="font-size: 0.75rem; background-color: #fff5f5; color: #c00; border: 1px solid #fcc; padding: 4px 8px; border-radius: 2px;">
                                </div>
                            </div>
                        </div>
                    </a>

                    <a href="javascript:void(0)" class="dropdown-item py-3 px-3 menu-action-link" id="menu_naf"
                        onclick="handleAction('NAF', 'nutrition_alert_form.html')">
                        <div class="d-flex">
                            <div class="mr-3 d-flex align-items-center justify-content-center icon-box"
                                style="width: 45px; height: 45px; background-color: #f1f8ff; border: 1px solid #d0e2f5; border-radius: 4px; color: #0d47a1;">
                                <i class="fa-solid fa-clipboard-user fa-lg"></i>
                            </div>
                            <div class="w-100">
                                <span class="font-weight-bold text-dark title-text"
                                    style="font-size: 1rem;">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</span>
                                <small class="text-muted sub-text d-block mb-1">Nutrition Alert Form (NAF)</small>
                                <div class="reason-text d-none mt-1"
                                    style="font-size: 0.75rem; background-color: #fff5f5; color: #c00; border: 1px solid #fcc; padding: 4px 8px; border-radius: 2px;">
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div id="currentStatusCard" class="his-container d-none p-0 overflow-hidden">
                    <div class="row no-gutters">
                        <div class="col-md-8 p-4 d-flex flex-column border-right-md">
                            <div class="d-flex align-items-center justify-content-between mb-3 pb-2 border-bottom">
                                <h6 class="font-weight-bold m-0 text-primary-custom">
                                    <i class="fa-solid fa-clipboard-check mr-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                                </h6>
                                <span id="cur_source_badge"
                                    class="badge badge-light border text-muted font-weight-normal px-2">-</span>
                            </div>

                            <div class="d-flex align-items-start mb-3">
                                <div class="flex-grow-1 pr-3">
                                    <small class="text-uppercase text-muted font-weight-bold" id="cur_type_label"
                                        style="font-size: 0.75rem;">-</small>
                                    <h4 id="cur_status_text" class="his-result mt-1 mb-2" style="font-size: 1.5rem;">-
                                    </h4>
                                    <p id="cur_status_desc" class="text-muted"
                                        style="font-size: 0.95rem; line-height: 1.5;">-
                                    </p>
                                </div>
                                <div class="text-center pl-3 border-left">
                                    <div class="score-circle shadow-sm bg-white mx-auto mb-1"
                                        style="width: 60px; height: 60px; font-size: 1.6rem;">
                                        <span id="cur_score_val">-</span>
                                    </div>
                                    <small class="text-muted font-weight-bold"
                                        style="font-size: 0.7rem;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</small>
                                </div>
                            </div>

                            <div class="mt-auto">
                                <div class="d-flex align-items-center bg-light rounded p-2" style="font-size: 0.85rem;">
                                    <div class="mr-4 d-flex align-items-center">
                                        <i class="fa-regular fa-calendar text-muted mr-2"></i>
                                        <span id="cur_date_text" class="font-weight-medium text-dark">-</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="fa-solid fa-user-nurse text-muted mr-2"></i>
                                        <span id="cur_assessor_text" class="font-weight-medium text-dark">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 p-4 d-flex flex-column justify-content-center bg-white">
                            <div class="w-100">
                                <h6 class="text-muted font-weight-bold text-uppercase mb-3"
                                    style="font-size: 0.75rem; letter-spacing: 1px;">
                                    ‡∏™‡∏¥‡πà‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Next Action)
                                </h6>
                                <div id="cur_next_action" class="w-100"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border shadow-sm mb-5">
                    <div class="card-header bg-white py-3 d-flex flex-wrap justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary-custom">
                            <i class="fa-solid fa-clock-rotate-left mr-2"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </h6>
                        <div class="form-inline mt-2 mt-md-0">
                            <label class="small mr-2 text-muted">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á:</label>
                            <select class="custom-select custom-select-sm" id="typeFilter" onchange="filterHistory()">
                                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                                <option value="SPENT">‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ (SPENT)</option>
                                <option value="NAF">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ (NAF)</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-custom mb-0">
                                <thead>
                                    <tr>
                                        <th style="min-width: 180px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                                        <th style="width: 80px;" class="text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                        <th style="width: 60px;" class="text-center">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà</th>
                                        <th style="width: 60px;" class="text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                                        <th style="min-width: 120px;" class="text-center">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á (SPENT)</th>
                                        <th style="min-width: 120px;" class="text-center">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (NAF)</th>
                                        <th style="min-width: 150px;">‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
                                        <th style="min-width: 130px;">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                                        <th style="width: 110px;" class="text-center">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div id="noHistory" class="text-center py-4 d-none">
                            <p class="text-muted mb-0">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>

    <script>
        const CURRENT_USER = '‡πÄ‡∏û‡∏ä‡∏£‡∏•‡∏î‡∏≤ ‡πÄ‡∏ä‡∏¢‡πÄ‡∏û‡πá‡∏ä‡∏£';

        const patients = [
            {
                id: 1,
                bed: '101', ward: '1', departmentText: '‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏¢',
                hn: '6604589', an: '6700123', name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', age: 45,
                underlying: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á (HT)',
                doctor: '‡∏ô‡∏û. ‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏î‡∏µ',
                admitDate: '15 ‡∏û.‡∏¢. 67 08:30 ‡∏ô.',
                screenDate: '24 ‡∏û.‡∏¢. 67',
                screenCount: 2,
                assessDate: '-',
                status: 'normal', scoreVal: 1, nafScore: null,
                screenAssessor: '‡∏û‡∏¢. ‡∏™‡∏°‡∏®‡∏£‡∏µ ‡πÉ‡∏à‡∏î‡∏µ',
                phone: '081-111-1111'
            },
            {
                id: 2,
                bed: '102', ward: '2', departmentText: '‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ç‡∏¥‡∏á',
                hn: '6605112', an: '6700145', name: '‡∏ô‡∏≤‡∏á‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', age: 62,
                underlying: '‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (DM), ‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ï (CKD)',
                doctor: '‡∏û‡∏ç. ‡πÉ‡∏à‡∏î‡∏µ ‡∏°‡∏µ‡πÄ‡∏°‡∏ï‡∏ï‡∏≤',
                admitDate: '25 ‡∏û.‡∏¢. 67 10:15 ‡∏ô.',
                screenDate: '-',
                screenCount: 0,
                assessDate: '-',
                status: 'wait_screen', scoreVal: null, nafScore: null,
                phone: '082-222-2222'
            },
            {
                id: 3,
                bed: '103', ward: '1', departmentText: '‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏¢',
                hn: '6603321', an: '6700189', name: '‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç', age: 75,
                underlying: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á (DLP)',
                doctor: '‡∏ô‡∏û. ‡πÄ‡∏Å‡πà‡∏á‡∏Å‡∏≤‡∏à ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£',
                admitDate: '18 ‡∏û.‡∏¢. 67 14:20 ‡∏ô.',
                screenDate: '20 ‡∏û.‡∏¢. 67',
                screenCount: 1,
                assessDate: '-',
                status: 'wait_assess', scoreVal: 3, nafScore: null,
                screenAssessor: '‡∏û‡∏¢. ‡∏™‡∏≤‡∏¢‡πÉ‡∏à ‡πÄ‡∏Å‡πà‡∏á‡∏á‡∏≤‡∏ô',
                phone: '083-333-3333'
            },
            {
                id: 4,
                bed: '105', ward: '3', departmentText: '‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å',
                hn: '6609888', an: '6700300', name: '‡∏ô‡∏≤‡∏¢‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á', age: 55,
                underlying: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß',
                doctor: '‡∏ô‡∏û. ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç ‡∏á‡∏≤‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',
                admitDate: '10 ‡∏û.‡∏¢. 67 20:45 ‡∏ô.',
                screenDate: '15 ‡∏û.‡∏¢. 67',
                screenCount: 1,
                assessDate: '-',
                status: 'normal', scoreVal: 0, nafScore: null,
                screenAssessor: '‡∏û‡∏¢. ‡∏™‡∏°‡∏®‡∏£‡∏µ ‡πÉ‡∏à‡∏î‡∏µ',
                phone: '084-444-4444'
            },
            {
                id: 5,
                bed: '106', ward: '2', departmentText: '‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ç‡∏¥‡∏á',
                hn: '6601122', an: '6700450', name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏ô‡∏µ ‡∏°‡∏µ‡∏ô‡∏≤', age: 30,
                underlying: '‡πÑ‡∏°‡πà‡∏°‡∏µ',
                doctor: '‡∏û‡∏ç. ‡πÉ‡∏à‡∏î‡∏µ ‡∏°‡∏µ‡πÄ‡∏°‡∏ï‡∏ï‡∏≤',
                admitDate: '23 ‡∏ò.‡∏Ñ. 68 10:45 ‡∏ô.',
                screenDate: '22 ‡∏û.‡∏¢. 67',
                screenCount: 1,
                assessDate: '23 ‡∏ò.‡∏Ñ. 68',
                status: 'assessed', scoreVal: 9, nafScore: 'B',
                screenAssessor: '‡∏û‡∏¢. ‡∏ß‡∏£‡∏£‡∏ì‡∏≤ ‡∏£‡∏±‡∏Å‡∏î‡∏µ',
                assessAssessor: CURRENT_USER,
                phone: '089-999-9999'
            },
            {
                id: 6,
                bed: '201', ward: '1', departmentText: '‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏¢',
                hn: '6609999', an: '6700999', name: '‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ô‡πà‡∏ô ‡∏≠‡∏î‡∏ó‡∏ô', age: 80,
                underlying: '‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á‡∏õ‡∏≠‡∏î',
                doctor: '‡∏ô‡∏û. ‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏î‡∏µ',
                admitDate: '20 ‡∏û.‡∏¢. 67 11:00 ‡∏ô.',
                screenDate: '21 ‡∏û.‡∏¢. 67',
                screenCount: 1,
                assessDate: '22 ‡∏û.‡∏¢. 67',
                status: 'assessed', scoreVal: 15, nafScore: 'C',
                screenAssessor: '‡∏û‡∏¢. ‡∏™‡∏°‡∏®‡∏£‡∏µ ‡πÉ‡∏à‡∏î‡∏µ',
                assessAssessor: '‡∏ô‡∏±‡∏Å‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡∏õ‡∏£‡∏≤‡∏ì‡∏µ (‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô)',
                phone: '085-555-5555'
            }
        ];

        let currentPatient = null;

        document.addEventListener('DOMContentLoaded', function () {
            const params = new URLSearchParams(window.location.search);
            const hn = params.get('hn');

            if (hn) {
                currentPatient = patients.find(p => p.hn === hn);
                if (currentPatient) {
                    renderPatientData(currentPatient);
                    renderHistory(currentPatient);
                    updateMenuActions(currentPatient);
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢');
                    window.location.href = 'index.html';
                }
            } else {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (HN)');
                window.location.href = 'index.html';
            }
        });

        function renderPatientData(p) {
            document.getElementById('p_hn').innerText = p.hn;
            document.getElementById('p_an').innerText = p.an;
            document.getElementById('p_name').innerText = p.name;
            document.getElementById('p_age').innerText = p.age + " ‡∏õ‡∏µ";
            document.getElementById('p_ward').innerText = `${p.departmentText} / ${p.bed}`;
            document.getElementById('p_doctor').innerText = p.doctor;
            document.getElementById('p_admit').innerText = p.admitDate;
            document.getElementById('p_underlying').innerText = p.underlying;
            document.getElementById('p_phone').innerText = p.phone || "-";
        }

        // --- 9-Column Table Logic (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏õ‡πá‡∏ô docNo) ---
        function renderHistory(p) {
            let history = [];

            // 1. Mock Data Generation (Old Data)
            if (p.screenDate && p.screenDate !== '-') {
                let screenScore = p.scoreVal;
                if (p.status === 'assessed') screenScore = 3;

                history.push({
                    timestamp: 1000,
                    date: p.screenDate,
                    type: 'SPENT',
                    name: '‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ (SPENT)',
                    score: screenScore,
                    result: screenScore >= 3 ? '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á' : '‡∏õ‡∏Å‡∏ï‡∏¥',
                    assessor: p.screenAssessor || '‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)',
                    url: 'nutrition_screening_form.html',
                    docNo: 'SPENT-OLD-001'
                });
            }

            if (p.status === 'assessed') {
                let nafResult = 'Normal (A)';
                if (p.nafScore === 'B') nafResult = 'Moderate (B)';
                if (p.nafScore === 'C') nafResult = 'Severe (C)';

                history.push({
                    timestamp: 2000,
                    date: p.assessDate,
                    type: 'NAF',
                    name: '‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ (NAF)',
                    score: p.scoreVal,
                    result: nafResult,
                    assessor: p.assessAssessor || CURRENT_USER,
                    url: 'nutrition_alert_form.html',
                    docNo: 'NAF-OLD-001'
                });
            }

            // 2. Fetch New Data from LocalStorage
            const storedHistory = JSON.parse(localStorage.getItem('nas_patient_history')) || [];
            const patientHistory = storedHistory.filter(item => item.hn === p.hn);

            // Merge Mock + Stored
            history = [...history, ...patientHistory];

            // -----------------------------------------------------------
            // üî¥ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Logic ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Fix Count)
            // -----------------------------------------------------------

            // 1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å "‡πÄ‡∏Å‡πà‡∏≤ -> ‡πÉ‡∏´‡∏°‡πà" ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö 1, 2, 3 ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤)
            history.sort((a, b) => a.timestamp - b.timestamp);

            // 2. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡πÅ‡∏¢‡∏Å
            let countSpent = 0;
            let countNaf = 0;

            // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            history = history.map((item) => {
                let showId = 0;

                if (item.type === 'SPENT') {
                    countSpent++;       // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô SPENT ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö SPENT
                    showId = countSpent;
                } else if (item.type === 'NAF') {
                    countNaf++;         // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô NAF ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö NAF
                    showId = countNaf;
                }

                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Object ‡πÄ‡∏î‡∏¥‡∏° + displayId ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                return { ...item, displayId: showId };
            });

            // 4. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡∏±‡∏ö "‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏Å‡πà‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î)
            history.reverse();

            // -----------------------------------------------------------

            // Render Table
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (history.length === 0) {
                document.getElementById('noHistory').classList.remove('d-none');
            } else {
                document.getElementById('noHistory').classList.add('d-none');

                history.forEach((h) => {
                    // 2. Type Badge with COLORS
                    let typeBadge = '';
                    if (h.type === 'SPENT') typeBadge = `<span class="badge badge-primary" style="width: 60px;">SPENT</span>`;
                    else typeBadge = `<span class="badge badge-success" style="width: 60px;">NAF</span>`;

                    // 5 & 6 Result Columns
                    let colSpent = '-';
                    let colNaf = '-';

                    if (h.type === 'SPENT') {
                        colSpent = h.score >= 2 ? `<span class="text-warning font-weight-bold">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</span>` : `<span class="text-success">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
                    } else if (h.type === 'NAF') {
                        if (h.result.includes('Severe') || h.result.includes('C')) colNaf = `<span class="badge badge-danger">NAF C</span>`;
                        else if (h.result.includes('Moderate') || h.result.includes('B')) colNaf = `<span class="badge badge-warning">NAF B</span>`;
                        else colNaf = `<span class="badge badge-success">NAF A</span>`;
                    }

                    // 7. Assessor
                    let displayAssessor = h.assessor;
                    if (h.assessor === CURRENT_USER) {
                        displayAssessor = `<span class="text-primary font-weight-bold">${h.assessor} (‡∏Ñ‡∏∏‡∏ì)</span>`;
                    }

                    // ‡πÉ‡∏ä‡πâ docNo ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ timestamp
                    const viewParam = h.docNo ? `docNo=${h.docNo}` : `view=${h.timestamp}`;

                    const row = `
                        <tr data-type="${h.type}">
                            <td>
                                <a href="${h.url}?hn=${p.hn}&${viewParam}" class="font-weight-bold text-dark text-decoration-none">
                                    ${h.name}
                                </a>
                                <div class="small text-muted">${h.docNo || '-'}</div>
                            </td>
                            <td class="text-center">${typeBadge}</td>
                            <td class="text-center text-muted">${h.displayId}</td>
                            <td class="text-center font-weight-bold">${h.score}</td>
                            <td class="text-center">${colSpent}</td>
                            <td class="text-center">${colNaf}</td>
                            <td><small class="text-muted">${displayAssessor}</small></td>
                            <td><small>${h.date}</small></td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-info" onclick="window.location.href='${h.url}?hn=${p.hn}&${viewParam}'" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="alert('‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå PDF: ${h.name}')" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }

            // Update Current Status Card (Topmost status from history)
            updateCurrentStatusCard(p, history.length > 0 ? history[0] : null);
        }

        function updateCurrentStatusCard(p, latest) {
            const card = document.getElementById('currentStatusCard');
            if (!latest && p.status === 'wait_screen') return;

            card.classList.remove('d-none');
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
            card.className = 'his-container p-0 overflow-hidden mb-4';

            const els = {
                badge: document.getElementById('cur_source_badge'),
                label: document.getElementById('cur_type_label'),
                text: document.getElementById('cur_status_text'),
                desc: document.getElementById('cur_status_desc'),
                score: document.getElementById('cur_score_val'),
                date: document.getElementById('cur_date_text'),
                assessor: document.getElementById('cur_assessor_text'),
                action: document.getElementById('cur_next_action')
            };

            let activeData = latest;

            if (!activeData) return;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
            if (activeData.assessor === CURRENT_USER) {
                els.assessor.innerHTML = `<span class="text-primary font-weight-bold">${activeData.assessor} (‡∏Ñ‡∏∏‡∏ì)</span>`;
            } else {
                els.assessor.innerText = activeData.assessor;
            }

            els.date.innerText = activeData.date;
            els.score.innerText = activeData.score;

            // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô SPENT ---
            if (activeData.type === 'SPENT') {
                els.badge.innerText = 'Latest: SPENT';
                els.badge.className = 'badge badge-light border text-primary px-2';
                els.label.innerText = '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';

                if (activeData.score >= 2) {
                    // High Risk
                    card.classList.add('his-risk');
                    els.text.innerText = '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (At Risk)';
                    els.text.className = 'his-result mt-1 mb-2 text-his-risk';
                    els.desc.innerText = '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô SPENT ‚â• 2 ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô NAF';
                    els.action.innerHTML = `
                        <div class="clinical-action-box status-urgent">
                            <div class="d-flex">
                                <i class="fa-solid fa-user-md clinical-action-icon"></i>
                                <div>
                                    <div class="clinical-title">‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô NAF</div>
                                    <p class="clinical-desc">‡πÇ‡∏õ‡∏£‡∏î‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Nutrition Alert Form ‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                                    <button class="btn btn-sm btn-warning mt-2 shadow-sm" onclick="window.location.href='nutrition_alert_form.html?hn=${p.hn}'">
                                        <i class="fa-solid fa-clipboard-list mr-1"></i> ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Normal
                    card.classList.add('his-normal');
                    els.text.innerText = '‡∏õ‡∏Å‡∏ï‡∏¥ (Normal)';
                    els.text.className = 'his-result mt-1 mb-2 text-his-normal';
                    els.desc.innerText = '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô NAF ‡∏ï‡πà‡∏≠';
                    els.action.innerHTML = `
                        <div class="clinical-action-box status-normal">
                            <div class="d-flex">
                                <i class="fa-solid fa-check-circle clinical-action-icon"></i>
                                <div>
                                    <div class="clinical-title">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏• (Follow up)</div>
                                    <p class="clinical-desc">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô (Re-screen)</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô NAF (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤) ---
            else if (activeData.type === 'NAF') {
                els.badge.innerText = 'Latest: NAF';
                els.badge.className = 'badge badge-light border text-success px-2';
                els.label.innerText = '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (NAF)';

                const score = parseInt(activeData.score);

                if (score >= 11) {
                    // NAF C (Severe) -> ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                    card.classList.add('his-severe');
                    els.text.innerText = 'NAF C (Severe Malnutrition)';
                    els.text.className = 'his-result mt-1 mb-2 text-his-severe';
                    els.desc.innerText = '‡∏°‡∏µ‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏∏‡∏û‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á';
                    els.action.innerHTML = `
                        <div class="clinical-action-box status-urgent">
                            <div class="d-flex">
                                <i class="fa-solid fa-truck-medical clinical-action-icon"></i>
                                <div>
                                    <div class="clinical-title">‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (24 ‡∏ä‡∏°.)</div>
                                    <p class="clinical-desc">‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏ô‡∏±‡∏Å‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (score >= 6) {
                    // NAF B (Moderate) -> ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á/‡∏™‡πâ‡∏°
                    card.classList.add('his-risk');
                    els.text.innerText = 'NAF B (Moderate Malnutrition)';
                    els.text.className = 'his-result mt-1 mb-2 text-his-risk';
                    els.desc.innerText = '‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏∏‡∏û‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
                    els.action.innerHTML = `
                        <div class="clinical-action-box status-overdue"> <div class="d-flex">
                                <i class="fa-solid fa-user-doctor clinical-action-icon"></i>
                                <div>
                                    <div class="clinical-title">‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤ (3 ‡∏ß‡∏±‡∏ô)</div>
                                    <p class="clinical-desc">‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏ô‡∏±‡∏Å‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3 ‡∏ß‡∏±‡∏ô</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // NAF A (Normal) -> ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    card.classList.add('his-normal');
                    els.text.innerText = 'NAF A (Normal/Mild)';
                    els.text.className = 'his-result mt-1 mb-2 text-his-normal';
                    els.desc.innerText = ' ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏∏‡∏û‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≠‡∏¢';
                    els.action.innerHTML = `
                        <div class="clinical-action-box status-normal">
                            <div class="d-flex">
                                <i class="fa-regular fa-clock clinical-action-icon"></i>
                                <div>
                                    <div class="clinical-title">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ã‡πâ‡∏≥ (7 ‡∏ß‡∏±‡∏ô)</div>
                                    <p class="clinical-desc">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        function updateMenuActions(p) {
            const menuSpent = document.getElementById('menu_spent');
            const menuNaf = document.getElementById('menu_naf');
            menuSpent.classList.remove('disabled-action');
            menuNaf.classList.remove('disabled-action');
        }

        function filterHistory() {
            const filter = document.getElementById('typeFilter').value;
            const rows = document.getElementById('historyTableBody').getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const type = rows[i].getAttribute('data-type');
                if (filter === 'all' || type === filter) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }

        function handleAction(type, url) {
            if (currentPatient) {
                window.location.href = `${url}?hn=${currentPatient.hn}`;
            }
        }

        function confirmLogout() {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) window.location.href = 'index.html';
        }
    </script>
</body>

</html>